<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otimizador de Cortes Hidr√°ulicos - CAD Professional</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #ffffff;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 100vh;
            background: #1e1e1e;
        }

        /* Sidebar esquerda - Biblioteca de Blocos */
        .sidebar-left {
            width: 300px;
            background: #2d2d2d;
            border-right: 1px solid #404040;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 15px;
            background: #3d3d3d;
            border-bottom: 1px solid #404040;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .categoria-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 6px 12px;
            background: #404040;
            border: none;
            border-radius: 4px;
            color: #cccccc;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #0078d4;
            color: white;
        }

        .tab-btn:hover {
            background: #505050;
        }

        .tab-btn.active:hover {
            background: #106ebe;
        }

        .blocos-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .bloco-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: #3d3d3d;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .bloco-item:hover {
            background: #4d4d4d;
            border-color: #0078d4;
        }

        .bloco-item.selected {
            background: #0078d4;
            border-color: #106ebe;
        }

        .bloco-icon {
            width: 32px;
            height: 32px;
            background: #505050;
            border-radius: 4px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .bloco-info {
            flex: 1;
            min-width: 0;
        }

        .bloco-nome {
            font-size: 12px;
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 2px;
        }

        .bloco-codigo {
            font-size: 10px;
            color: #cccccc;
            font-family: 'Courier New', monospace;
        }

        /* Canvas Central */
        .canvas-container {
            flex: 1;
            position: relative;
            background: #000000;
            overflow: hidden;
        }

        .canvas-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: #2d2d2d;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 100;
        }

        .canvas-tools {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .tool-button {
            width: 32px;
            height: 32px;
            background: #404040;
            border: none;
            border-radius: 4px;
            color: #cccccc;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .tool-button:hover {
            background: #505050;
            color: white;
        }

        .tool-button.active {
            background: #0078d4;
            color: white;
        }

        .coordinates-display {
            margin-left: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #cccccc;
            background: #1e1e1e;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .canvas-viewport {
            position: absolute;
            top: 40px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            cursor: crosshair;
        }

        .canvas-svg {
            width: 100%;
            height: 100%;
            background: #000000;
        }

        /* Grid de fundo */
        .grid-pattern {
            fill: none;
            stroke: #333333;
            stroke-width: 0.5;
            opacity: 0.3;
        }

        .grid-major {
            stroke: #555555;
            stroke-width: 1;
            opacity: 0.5;
        }

        /* Pe√ßas no canvas */
        .canvas-piece {
            cursor: move;
            transition: all 0.1s ease;
        }

        .canvas-piece:hover {
            filter: brightness(1.2);
        }

        .canvas-piece.selected {
            filter: brightness(1.3);
            stroke: #0078d4;
            stroke-width: 2;
        }

        .canvas-piece.dragging {
            opacity: 0.8;
            filter: brightness(1.5);
        }

        /* Preview da pe√ßa sendo inserida */
        .piece-preview {
            opacity: 0.7;
            pointer-events: none;
            filter: brightness(1.2);
        }

        /* Pontos de snap */
        .snap-point {
            fill: #00ff00;
            stroke: #ffffff;
            stroke-width: 1;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .snap-point.active {
            opacity: 1;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Sidebar direita - Propriedades */
        .sidebar-right {
            width: 280px;
            background: #2d2d2d;
            border-left: 1px solid #404040;
            display: flex;
            flex-direction: column;
        }

        .properties-panel {
            padding: 15px;
            border-bottom: 1px solid #404040;
        }

        .properties-title {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .property-group {
            margin-bottom: 15px;
        }

        .property-label {
            font-size: 11px;
            color: #cccccc;
            margin-bottom: 5px;
        }

        .property-input {
            width: 100%;
            padding: 6px 8px;
            background: #404040;
            border: 1px solid #555555;
            border-radius: 4px;
            color: #ffffff;
            font-size: 11px;
        }

        .property-input:focus {
            outline: none;
            border-color: #0078d4;
        }

        .layers-panel {
            flex: 1;
            padding: 15px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 6px;
            margin-bottom: 3px;
            background: #3d3d3d;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .layer-item:hover {
            background: #4d4d4d;
        }

        .layer-item.active {
            background: #0078d4;
        }

        .layer-visibility {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            cursor: pointer;
        }

        .layer-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 8px;
        }

        .layer-name {
            flex: 1;
            font-size: 11px;
            color: #ffffff;
        }

        /* Status bar */
        .status-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 24px;
            background: #2d2d2d;
            border-top: 1px solid #404040;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 11px;
            color: #cccccc;
            z-index: 100;
        }

        .status-item {
            margin-right: 20px;
        }

        /* Comandos */
        .command-line {
            position: absolute;
            bottom: 24px;
            left: 0;
            right: 0;
            height: 30px;
            background: #1e1e1e;
            border-top: 1px solid #404040;
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 100;
        }

        .command-prompt {
            color: #00ff00;
            margin-right: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #ffffff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            outline: none;
        }

        /* Scrollbars customizadas */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        ::-webkit-scrollbar-thumb {
            background: #555555;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666666;
        }

        /* Responsividade */
        @media (max-width: 1024px) {
            .sidebar-left {
                width: 250px;
            }
            
            .sidebar-right {
                width: 220px;
            }
        }

        @media (max-width: 768px) {
            .sidebar-left,
            .sidebar-right {
                position: absolute;
                top: 0;
                bottom: 0;
                z-index: 200;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar-right {
                right: 0;
                transform: translateX(100%);
            }
            
            .sidebar-left.open,
            .sidebar-right.open {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Sidebar Esquerda - Biblioteca de Blocos -->
        <div class="sidebar-left">
            <div class="sidebar-header">
                <div class="sidebar-title">üìö Biblioteca Tigre BIM</div>
                <div class="categoria-tabs">
                    <button class="tab-btn active" data-categoria="todas">Todas</button>
                    <button class="tab-btn" data-categoria="esgoto">Esgoto</button>
                    <button class="tab-btn" data-categoria="irrigacao">Irriga√ß√£o</button>
                    <button class="tab-btn" data-categoria="soldavel">Sold√°vel</button>
                    <button class="tab-btn" data-categoria="caixa-dagua">Caixa D'√Ågua</button>
                </div>
            </div>
            <div class="blocos-container" id="blocos-container">
                <!-- Blocos ser√£o carregados aqui -->
            </div>
        </div>

        <!-- Canvas Central -->
        <div class="canvas-container">
            <div class="canvas-header">
                <div class="canvas-tools">
                    <button class="tool-button active" data-tool="select" title="Selecionar (S)">‚¨Ü</button>
                    <button class="tool-button" data-tool="move" title="Mover (M)">‚úã</button>
                    <button class="tool-button" data-tool="rotate" title="Rotacionar (R)">üîÑ</button>
                    <button class="tool-button" data-tool="copy" title="Copiar (C)">üìã</button>
                    <button class="tool-button" data-tool="delete" title="Excluir (Del)">üóë</button>
                    <div style="width: 1px; height: 24px; background: #404040; margin: 0 5px;"></div>
                    <button class="tool-button" data-tool="zoom-in" title="Zoom In (+)">üîç</button>
                    <button class="tool-button" data-tool="zoom-out" title="Zoom Out (-)">üîç</button>
                    <button class="tool-button" data-tool="zoom-fit" title="Ajustar √† Tela (F)">üìê</button>
                    <button class="tool-button" data-tool="pan" title="Pan (P)">üëã</button>
                </div>
                <div class="coordinates-display" id="coordinates">X: 0.00, Y: 0.00</div>
            </div>

            <div class="canvas-viewport" id="canvas-viewport">
                <svg class="canvas-svg" id="canvas-svg" viewBox="0 0 2000 1500">
                    <!-- Grid de fundo -->
                    <defs>
                        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 20 0 L 0 0 0 20" class="grid-pattern"/>
                        </pattern>
                        <pattern id="grid-major" width="100" height="100" patternUnits="userSpaceOnUse">
                            <path d="M 100 0 L 0 0 0 100" class="grid-major"/>
                        </pattern>
                    </defs>
                    
                    <!-- Fundo com grid -->
                    <rect width="100%" height="100%" fill="url(#grid)"/>
                    <rect width="100%" height="100%" fill="url(#grid-major)"/>
                    
                    <!-- Grupo para pe√ßas -->
                    <g id="pieces-group"></g>
                    
                    <!-- Grupo para preview -->
                    <g id="preview-group"></g>
                    
                    <!-- Grupo para pontos de snap -->
                    <g id="snap-points-group"></g>
                </svg>
            </div>

            <!-- Linha de comando -->
            <div class="command-line">
                <span class="command-prompt">Command:</span>
                <input type="text" class="command-input" id="command-input" placeholder="Digite um comando...">
            </div>

            <!-- Status bar -->
            <div class="status-bar">
                <span class="status-item">Snap: ON</span>
                <span class="status-item">Grid: ON</span>
                <span class="status-item">Ortho: OFF</span>
                <span class="status-item" id="zoom-level">Zoom: 100%</span>
                <span class="status-item" id="piece-count">Pe√ßas: 0</span>
            </div>
        </div>

        <!-- Sidebar Direita - Propriedades -->
        <div class="sidebar-right">
            <div class="properties-panel">
                <div class="properties-title">üîß Propriedades</div>
                <div id="properties-content">
                    <div class="property-group">
                        <div class="property-label">Nenhuma pe√ßa selecionada</div>
                    </div>
                </div>
            </div>

            <div class="layers-panel">
                <div class="properties-title">üìã Layers</div>
                <div id="layers-list">
                    <div class="layer-item active">
                        <div class="layer-visibility">üëÅ</div>
                        <div class="layer-color" style="background: #ffffff;"></div>
                        <div class="layer-name">0 - Padr√£o</div>
                    </div>
                    <div class="layer-item">
                        <div class="layer-visibility">üëÅ</div>
                        <div class="layer-color" style="background: #ff0000;"></div>
                        <div class="layer-name">Esgoto</div>
                    </div>
                    <div class="layer-item">
                        <div class="layer-visibility">üëÅ</div>
                        <div class="layer-color" style="background: #0000ff;"></div>
                        <div class="layer-name">√Ågua Fria</div>
                    </div>
                    <div class="layer-item">
                        <div class="layer-visibility">üëÅ</div>
                        <div class="layer-color" style="background: #00ff00;"></div>
                        <div class="layer-name">Irriga√ß√£o</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cat√°logo de blocos Tigre BIM
        const blocosDisponiveis = [
            {
                id: 'cap-esg-dn40',
                nome: 'Cap Esgoto DN40',
                categoria: 'esgoto',
                codigo: '100002791',
                preco: 8.50,
                largura: 40,
                altura: 40,
                pontos_snap: [{x: 20, y: 40, tipo: 'conexao'}],
                svg: `<g>
                    <circle cx="20" cy="20" r="16" fill="#e2e8f0" stroke="#64748b" stroke-width="1"/>
                    <rect x="16" y="32" width="8" height="6" fill="#94a3b8" stroke="#64748b"/>
                    <circle cx="20" cy="20" r="12" fill="none" stroke="#64748b" stroke-width="1"/>
                    <circle cx="20" cy="20" r="2" fill="#64748b"/>
                </g>`
            },
            {
                id: 'joelho-90-dn100',
                nome: 'Joelho 90¬∞ DN100',
                categoria: 'esgoto',
                codigo: '100002799',
                preco: 32.80,
                largura: 90,
                altura: 90,
                pontos_snap: [
                    {x: 15, y: 45, tipo: 'conexao'},
                    {x: 75, y: 75, tipo: 'conexao'}
                ],
                svg: `<g>
                    <path d="M 15 15 Q 15 15 15 45 Q 15 75 45 75 Q 75 75 75 75" 
                          fill="#e2e8f0" stroke="#64748b" stroke-width="8"/>
                    <rect x="10" y="40" width="10" height="10" fill="#94a3b8" stroke="#64748b"/>
                    <rect x="70" y="70" width="10" height="10" fill="#94a3b8" stroke="#64748b"/>
                </g>`
            },
            {
                id: 'te-90-dn100',
                nome: 'T√™ 90¬∞ DN100',
                categoria: 'esgoto',
                codigo: '100002804',
                preco: 45.60,
                largura: 90,
                altura: 90,
                pontos_snap: [
                    {x: 12, y: 45, tipo: 'conexao'},
                    {x: 78, y: 45, tipo: 'conexao'},
                    {x: 45, y: 12, tipo: 'conexao'}
                ],
                svg: `<g>
                    <rect x="10" y="40" width="70" height="10" fill="#e2e8f0" stroke="#64748b" stroke-width="1"/>
                    <rect x="40" y="10" width="10" height="70" fill="#e2e8f0" stroke="#64748b" stroke-width="1"/>
                    <rect x="8" y="38" width="4" height="14" fill="#94a3b8" stroke="#64748b"/>
                    <rect x="78" y="38" width="4" height="14" fill="#94a3b8" stroke="#64748b"/>
                    <rect x="38" y="8" width="14" height="4" fill="#94a3b8" stroke="#64748b"/>
                </g>`
            },
            {
                id: 'tubo-dn100-6m',
                nome: 'Tubo DN100 6M',
                categoria: 'esgoto',
                codigo: '100002789',
                preco: 48.90,
                largura: 120,
                altura: 35,
                pontos_snap: [
                    {x: 4, y: 17, tipo: 'conexao'},
                    {x: 116, y: 17, tipo: 'conexao'}
                ],
                svg: `<g>
                    <rect x="2" y="5" width="116" height="25" fill="#e2e8f0" 
                          stroke="#64748b" stroke-width="1" rx="5"/>
                    <rect x="0" y="8" width="4" height="19" fill="#94a3b8" stroke="#64748b"/>
                    <rect x="116" y="8" width="4" height="19" fill="#94a3b8" stroke="#64748b"/>
                </g>`
            },
            {
                id: 'torneira-boia-12',
                nome: 'Torneira Boia 1/2"',
                categoria: 'caixa-dagua',
                codigo: '100002305',
                preco: 35.80,
                largura: 80,
                altura: 40,
                pontos_snap: [{x: 76, y: 16, tipo: 'conexao'}],
                svg: `<g>
                    <rect x="5" y="15" width="30" height="10" fill="#10b981" stroke="#047857" stroke-width="1" rx="5"/>
                    <line x1="35" y1="20" x2="55" y2="15" stroke="#6b7280" stroke-width="3"/>
                    <circle cx="60" cy="12" r="8" fill="#f3f4f6" stroke="#6b7280" stroke-width="1"/>
                    <rect x="68" y="8" width="8" height="8" fill="#10b981" stroke="#047857"/>
                </g>`
            }
        ];

        // Estado da aplica√ß√£o
        let appState = {
            ferramentaAtiva: 'select',
            categoriaAtiva: 'todas',
            blocoSelecionado: null,
            pecaSelecionada: null,
            pecasCanvas: [],
            proximoId: 1,
            zoom: 1,
            pan: { x: 0, y: 0 },
            isDragging: false,
            isInserting: false,
            snapEnabled: true,
            gridEnabled: true,
            mousePos: { x: 0, y: 0 }
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            inicializarApp();
            carregarBlocos();
            configurarEventos();
            configurarComandos();
        });

        function inicializarApp() {
            // Configurar SVG
            const svg = document.getElementById('canvas-svg');
            svg.addEventListener('mousemove', atualizarCoordenadas);
            svg.addEventListener('click', handleCanvasClick);
            svg.addEventListener('contextmenu', handleCanvasRightClick);
        }

        function carregarBlocos() {
            const container = document.getElementById('blocos-container');
            container.innerHTML = '';

            const blocosFiltrados = appState.categoriaAtiva === 'todas' 
                ? blocosDisponiveis 
                : blocosDisponiveis.filter(bloco => bloco.categoria === appState.categoriaAtiva);

            blocosFiltrados.forEach(bloco => {
                const blocoElement = document.createElement('div');
                blocoElement.className = 'bloco-item';
                blocoElement.dataset.blocoId = bloco.id;

                blocoElement.innerHTML = `
                    <div class="bloco-icon">
                        <svg width="24" height="24" viewBox="0 0 ${bloco.largura} ${bloco.altura}">
                            ${bloco.svg}
                        </svg>
                    </div>
                    <div class="bloco-info">
                        <div class="bloco-nome">${bloco.nome}</div>
                        <div class="bloco-codigo">${bloco.codigo}</div>
                    </div>
                `;

                blocoElement.addEventListener('click', selecionarBloco);
                blocoElement.addEventListener('dblclick', iniciarInsercao);

                container.appendChild(blocoElement);
            });
        }

        function configurarEventos() {
            // Tabs de categoria
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    appState.categoriaAtiva = this.dataset.categoria;
                    carregarBlocos();
                });
            });

            // Ferramentas
            document.querySelectorAll('.tool-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tool = this.dataset.tool;
                    if (tool) {
                        ativarFerramenta(tool);
                    }
                });
            });

            // Teclado
            document.addEventListener('keydown', handleKeyDown);
        }

        function configurarComandos() {
            const commandInput = document.getElementById('command-input');
            commandInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    executarComando(this.value);
                    this.value = '';
                }
            });
        }

        function selecionarBloco(event) {
            // Remover sele√ß√£o anterior
            document.querySelectorAll('.bloco-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Selecionar novo bloco
            event.currentTarget.classList.add('selected');
            appState.blocoSelecionado = event.currentTarget.dataset.blocoId;
        }

        function iniciarInsercao(event) {
            const blocoId = event.currentTarget.dataset.blocoId;
            appState.blocoSelecionado = blocoId;
            appState.isInserting = true;
            ativarFerramenta('insert');
            
            // Mudar cursor
            document.getElementById('canvas-viewport').style.cursor = 'crosshair';
            
            // Mostrar preview
            mostrarPreview();
        }

        function mostrarPreview() {
            if (!appState.blocoSelecionado || !appState.isInserting) return;

            const bloco = blocosDisponiveis.find(b => b.id === appState.blocoSelecionado);
            if (!bloco) return;

            const previewGroup = document.getElementById('preview-group');
            previewGroup.innerHTML = `
                <g class="piece-preview" transform="translate(${appState.mousePos.x - bloco.largura/2}, ${appState.mousePos.y - bloco.altura/2})">
                    ${bloco.svg}
                </g>
            `;
        }

        function atualizarCoordenadas(event) {
            const svg = document.getElementById('canvas-svg');
            const rect = svg.getBoundingClientRect();
            const x = ((event.clientX - rect.left) / rect.width) * 2000;
            const y = ((event.clientY - rect.top) / rect.height) * 1500;
            
            appState.mousePos = { x, y };
            
            document.getElementById('coordinates').textContent = 
                `X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}`;

            if (appState.isInserting) {
                mostrarPreview();
                mostrarPontosSnap(x, y);
            }
        }

        function mostrarPontosSnap(x, y) {
            if (!appState.snapEnabled) return;

            const snapGroup = document.getElementById('snap-points-group');
            snapGroup.innerHTML = '';

            // Verificar snap com pe√ßas existentes
            appState.pecasCanvas.forEach(peca => {
                const blocoTemplate = blocosDisponiveis.find(b => b.id === peca.tipo);
                if (!blocoTemplate) return;

                blocoTemplate.pontos_snap.forEach(ponto => {
                    const snapX = peca.x + ponto.x;
                    const snapY = peca.y + ponto.y;
                    const distancia = Math.sqrt((x - snapX) ** 2 + (y - snapY) ** 2);

                    if (distancia < 20) { // Raio de snap
                        const snapPoint = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        snapPoint.setAttribute('cx', snapX);
                        snapPoint.setAttribute('cy', snapY);
                        snapPoint.setAttribute('r', '4');
                        snapPoint.setAttribute('class', 'snap-point active');
                        snapGroup.appendChild(snapPoint);
                    }
                });
            });
        }

        function handleCanvasClick(event) {
            if (appState.isInserting && appState.blocoSelecionado) {
                inserirPeca(event);
            } else if (appState.ferramentaAtiva === 'select') {
                selecionarPeca(event);
            }
        }

        function handleCanvasRightClick(event) {
            event.preventDefault();
            if (appState.isInserting) {
                cancelarInsercao();
            }
        }

        function inserirPeca(event) {
            const bloco = blocosDisponiveis.find(b => b.id === appState.blocoSelecionado);
            if (!bloco) return;

            const svg = document.getElementById('canvas-svg');
            const rect = svg.getBoundingClientRect();
            const x = ((event.clientX - rect.left) / rect.width) * 2000 - bloco.largura/2;
            const y = ((event.clientY - rect.top) / rect.height) * 1500 - bloco.altura/2;

            const novaPeca = {
                id: appState.proximoId++,
                tipo: bloco.id,
                nome: bloco.nome,
                codigo: bloco.codigo,
                preco: bloco.preco,
                x: x,
                y: y,
                largura: bloco.largura,
                altura: bloco.altura,
                rotacao: 0,
                layer: '0'
            };

            appState.pecasCanvas.push(novaPeca);
            renderizarCanvas();
            atualizarContadores();
            
            // Continuar inserindo se Shift estiver pressionado
            if (!event.shiftKey) {
                cancelarInsercao();
            }
        }

        function cancelarInsercao() {
            appState.isInserting = false;
            appState.blocoSelecionado = null;
            document.getElementById('canvas-viewport').style.cursor = 'crosshair';
            document.getElementById('preview-group').innerHTML = '';
            document.getElementById('snap-points-group').innerHTML = '';
            ativarFerramenta('select');
        }

        function renderizarCanvas() {
            const piecesGroup = document.getElementById('pieces-group');
            piecesGroup.innerHTML = '';

            appState.pecasCanvas.forEach(peca => {
                const blocoTemplate = blocosDisponiveis.find(b => b.id === peca.tipo);
                if (!blocoTemplate) return;

                const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                group.setAttribute('class', 'canvas-piece');
                group.setAttribute('data-piece-id', peca.id);
                group.setAttribute('transform', 
                    `translate(${peca.x}, ${peca.y}) rotate(${peca.rotacao}, ${peca.largura/2}, ${peca.altura/2})`);
                group.innerHTML = blocoTemplate.svg;

                group.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selecionarPecaCanvas(peca.id);
                });

                piecesGroup.appendChild(group);
            });
        }

        function selecionarPecaCanvas(pecaId) {
            // Remover sele√ß√£o anterior
            document.querySelectorAll('.canvas-piece').forEach(piece => {
                piece.classList.remove('selected');
            });

            // Selecionar nova pe√ßa
            const piece = document.querySelector(`[data-piece-id="${pecaId}"]`);
            if (piece) {
                piece.classList.add('selected');
                appState.pecaSelecionada = appState.pecasCanvas.find(p => p.id === pecaId);
                atualizarPropriedades();
            }
        }

        function atualizarPropriedades() {
            const container = document.getElementById('properties-content');
            
            if (!appState.pecaSelecionada) {
                container.innerHTML = `
                    <div class="property-group">
                        <div class="property-label">Nenhuma pe√ßa selecionada</div>
                    </div>
                `;
                return;
            }

            const peca = appState.pecaSelecionada;
            container.innerHTML = `
                <div class="property-group">
                    <div class="property-label">Nome</div>
                    <input type="text" class="property-input" value="${peca.nome}" readonly>
                </div>
                <div class="property-group">
                    <div class="property-label">C√≥digo</div>
                    <input type="text" class="property-input" value="${peca.codigo}" readonly>
                </div>
                <div class="property-group">
                    <div class="property-label">X</div>
                    <input type="number" class="property-input" value="${peca.x.toFixed(2)}" 
                           onchange="atualizarPosicao('x', this.value)">
                </div>
                <div class="property-group">
                    <div class="property-label">Y</div>
                    <input type="number" class="property-input" value="${peca.y.toFixed(2)}" 
                           onchange="atualizarPosicao('y', this.value)">
                </div>
                <div class="property-group">
                    <div class="property-label">Rota√ß√£o</div>
                    <input type="number" class="property-input" value="${peca.rotacao}" 
                           onchange="atualizarRotacao(this.value)">
                </div>
                <div class="property-group">
                    <div class="property-label">Layer</div>
                    <input type="text" class="property-input" value="${peca.layer}">
                </div>
            `;
        }

        function atualizarPosicao(eixo, valor) {
            if (!appState.pecaSelecionada) return;
            
            appState.pecaSelecionada[eixo] = parseFloat(valor);
            renderizarCanvas();
        }

        function atualizarRotacao(valor) {
            if (!appState.pecaSelecionada) return;
            
            appState.pecaSelecionada.rotacao = parseFloat(valor);
            renderizarCanvas();
        }

        function atualizarContadores() {
            document.getElementById('piece-count').textContent = `Pe√ßas: ${appState.pecasCanvas.length}`;
        }

        function ativarFerramenta(ferramenta) {
            // Remover active de todas as ferramentas
            document.querySelectorAll('.tool-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Ativar ferramenta selecionada
            const btn = document.querySelector(`[data-tool="${ferramenta}"]`);
            if (btn) {
                btn.classList.add('active');
            }

            appState.ferramentaAtiva = ferramenta;

            // Executar a√ß√£o da ferramenta
            switch (ferramenta) {
                case 'zoom-in':
                    zoom(1.2);
                    break;
                case 'zoom-out':
                    zoom(0.8);
                    break;
                case 'zoom-fit':
                    ajustarZoom();
                    break;
                case 'delete':
                    excluirPecaSelecionada();
                    break;
            }
        }

        function zoom(fator) {
            appState.zoom *= fator;
            appState.zoom = Math.max(0.1, Math.min(appState.zoom, 10));
            
            const svg = document.getElementById('canvas-svg');
            const novaLargura = 2000 / appState.zoom;
            const novaAltura = 1500 / appState.zoom;
            
            svg.setAttribute('viewBox', `${appState.pan.x} ${appState.pan.y} ${novaLargura} ${novaAltura}`);
            
            document.getElementById('zoom-level').textContent = `Zoom: ${Math.round(appState.zoom * 100)}%`;
        }

        function ajustarZoom() {
            if (appState.pecasCanvas.length === 0) {
                appState.zoom = 1;
                appState.pan = { x: 0, y: 0 };
            } else {
                // Calcular bounds das pe√ßas
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                
                appState.pecasCanvas.forEach(peca => {
                    minX = Math.min(minX, peca.x);
                    minY = Math.min(minY, peca.y);
                    maxX = Math.max(maxX, peca.x + peca.largura);
                    maxY = Math.max(maxY, peca.y + peca.altura);
                });

                const largura = maxX - minX + 100;
                const altura = maxY - minY + 100;
                
                appState.zoom = Math.min(2000 / largura, 1500 / altura);
                appState.pan = { x: minX - 50, y: minY - 50 };
            }

            const svg = document.getElementById('canvas-svg');
            const novaLargura = 2000 / appState.zoom;
            const novaAltura = 1500 / appState.zoom;
            
            svg.setAttribute('viewBox', `${appState.pan.x} ${appState.pan.y} ${novaLargura} ${novaAltura}`);
            
            document.getElementById('zoom-level').textContent = `Zoom: ${Math.round(appState.zoom * 100)}%`;
        }

        function excluirPecaSelecionada() {
            if (!appState.pecaSelecionada) return;

            const index = appState.pecasCanvas.findIndex(p => p.id === appState.pecaSelecionada.id);
            if (index !== -1) {
                appState.pecasCanvas.splice(index, 1);
                appState.pecaSelecionada = null;
                renderizarCanvas();
                atualizarPropriedades();
                atualizarContadores();
            }
        }

        function handleKeyDown(event) {
            // Ignorar se estiver digitando em input
            if (event.target.tagName === 'INPUT') return;

            switch (event.key.toLowerCase()) {
                case 's':
                    ativarFerramenta('select');
                    break;
                case 'm':
                    ativarFerramenta('move');
                    break;
                case 'r':
                    ativarFerramenta('rotate');
                    break;
                case 'c':
                    ativarFerramenta('copy');
                    break;
                case 'delete':
                    excluirPecaSelecionada();
                    break;
                case '+':
                case '=':
                    zoom(1.2);
                    break;
                case '-':
                    zoom(0.8);
                    break;
                case 'f':
                    ajustarZoom();
                    break;
                case 'escape':
                    if (appState.isInserting) {
                        cancelarInsercao();
                    }
                    break;
            }
        }

        function executarComando(comando) {
            const cmd = comando.toLowerCase().trim();
            
            switch (cmd) {
                case 'zoom':
                case 'z':
                    ativarFerramenta('zoom-fit');
                    break;
                case 'select':
                case 'sel':
                    ativarFerramenta('select');
                    break;
                case 'move':
                case 'mv':
                    ativarFerramenta('move');
                    break;
                case 'rotate':
                case 'rot':
                    ativarFerramenta('rotate');
                    break;
                case 'copy':
                case 'cp':
                    ativarFerramenta('copy');
                    break;
                case 'delete':
                case 'del':
                case 'erase':
                    excluirPecaSelecionada();
                    break;
                case 'grid':
                    toggleGrid();
                    break;
                case 'snap':
                    toggleSnap();
                    break;
                default:
                    console.log('Comando n√£o reconhecido:', comando);
            }
        }

        function toggleGrid() {
            appState.gridEnabled = !appState.gridEnabled;
            const gridElements = document.querySelectorAll('[fill*="grid"]');
            gridElements.forEach(el => {
                el.style.display = appState.gridEnabled ? 'block' : 'none';
            });
            
            document.querySelector('.status-item:nth-child(2)').textContent = 
                `Grid: ${appState.gridEnabled ? 'ON' : 'OFF'}`;
        }

        function toggleSnap() {
            appState.snapEnabled = !appState.snapEnabled;
            document.querySelector('.status-item:nth-child(1)').textContent = 
                `Snap: ${appState.snapEnabled ? 'ON' : 'OFF'}`;
        }

        // Inicializar com zoom ajustado
        setTimeout(() => {
            ajustarZoom();
        }, 100);
    </script>
</body>
</html>
