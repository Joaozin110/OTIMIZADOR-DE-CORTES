<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otimizador de Cortes Hidr√°ulicos - Vers√£o Completa</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1e1e1e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiT3RpbWl6YWRvciBkZSBDb3J0ZXMgSGlkcsOhdWxpY29zIiwic2hvcnRfbmFtZSI6Ik90aW1pemFkb3IiLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwidGhlbWVfY29sb3IiOiIjMWUxZTFlIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxZTFlMWUiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUhacFpYZENiM2c5SWpBZ01DQXhNamdnTVRJNElpQm1hV3hzUFNJak1URXhNU0krUEhKbFkzUWdlRDBpTVRZaUlIazlJakUySWlCM2FXUjBhRDBpT1RZaUlHaGxhV2RvZEQwaU9UWWlJSEo0UFNJNElpQm1hV3hzUFNJak16azVPVGxHSWk4K1BDOXpkbWMrIiwic2l6ZXMiOiIxMjh4MTI4IiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #ffffff;
            overflow: hidden;
            user-select: none;
        }

        /* Layout Principal */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 60px 1fr 30px;
            height: 100vh;
            gap: 1px;
            background: #333;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #2563eb, #1e40af);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 18px;
        }

        .header-tools {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-1px);
        }

        /* Sidebar Esquerda - Biblioteca */
        .sidebar-left {
            background: #2a2a2a;
            border-right: 1px solid #444;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-title {
            background: #333;
            padding: 15px;
            border-bottom: 1px solid #444;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 15px;
            border-bottom: 1px solid #444;
        }

        .category-btn {
            background: #444;
            border: none;
            color: #ccc;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .category-btn.active {
            background: #3b82f6;
            color: white;
        }

        .pieces-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .piece-item {
            background: #333;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .piece-item:hover {
            background: #3a3a3a;
            border-color: #3b82f6;
            transform: translateX(2px);
        }

        .piece-item.inserting {
            background: #1e40af;
            border-color: #3b82f6;
        }

        .piece-icon {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }

        .piece-info {
            flex: 1;
        }

        .piece-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .piece-code {
            font-size: 11px;
            color: #888;
            margin-bottom: 2px;
        }

        .piece-price {
            font-size: 12px;
            color: #4ade80;
            font-weight: bold;
        }

        /* Canvas Central */
        .canvas-container {
            background: #1a1a1a;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .canvas-toolbar {
            background: #2a2a2a;
            border-bottom: 1px solid #444;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tool-btn {
            background: #444;
            border: 1px solid #555;
            color: #ccc;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
        }

        .tool-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
        }

        .tool-btn:hover:not(.active) {
            background: #555;
        }

        .tool-badge {
            background: #ef4444;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            position: absolute;
            top: -5px;
            right: -5px;
            min-width: 18px;
            text-align: center;
        }

        .canvas-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .canvas-svg {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            background-image: 
                radial-gradient(circle, #333 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .canvas-svg.panning {
            cursor: grab;
        }

        .canvas-svg.panning:active {
            cursor: grabbing;
        }

        /* Coordenadas */
        .coordinates {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }

        /* Sidebar Direita - Propriedades */
        .sidebar-right {
            background: #2a2a2a;
            border-left: 1px solid #444;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .properties-panel {
            flex: 1;
            overflow-y: auto;
        }

        .panel-section {
            border-bottom: 1px solid #444;
        }

        .panel-header {
            background: #333;
            padding: 12px 15px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-content {
            padding: 15px;
        }

        .property-group {
            margin-bottom: 15px;
        }

        .property-label {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
            display: block;
        }

        .property-input {
            width: 100%;
            background: #444;
            border: 1px solid #555;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }

        .property-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .layer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #444;
        }

        .layer-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #666;
        }

        .layer-name {
            flex: 1;
            font-size: 14px;
        }

        .layer-controls {
            display: flex;
            gap: 5px;
        }

        .layer-btn {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            padding: 2px;
            font-size: 12px;
        }

        .layer-btn:hover {
            color: white;
        }

        /* Status Bar */
        .status-bar {
            grid-column: 1 / -1;
            background: #333;
            border-top: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            font-size: 12px;
            color: #ccc;
        }

        .command-line {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .command-input {
            background: #222;
            border: 1px solid #444;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-family: monospace;
            width: 300px;
        }

        .status-info {
            display: flex;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
        }

        .status-indicator.off {
            background: #ef4444;
        }

        /* Pe√ßas no Canvas */
        .canvas-piece {
            cursor: pointer;
            transition: all 0.2s;
        }

        .canvas-piece:hover {
            filter: brightness(1.2);
        }

        .canvas-piece.selected {
            stroke: #3b82f6;
            stroke-width: 2;
            stroke-dasharray: 5,5;
        }

        .canvas-piece.dragging {
            opacity: 0.8;
        }

        /* Pontos de Snap */
        .snap-point {
            fill: #4ade80;
            stroke: #22c55e;
            stroke-width: 1;
            opacity: 0;
            animation: pulse 1s infinite;
        }

        .snap-point.visible {
            opacity: 1;
        }

        @keyframes pulse {
            0%, 100% { r: 3; opacity: 0.8; }
            50% { r: 5; opacity: 1; }
        }

        /* Preview de Inser√ß√£o */
        .insertion-preview {
            opacity: 0.7;
            pointer-events: none;
            filter: drop-shadow(0 0 10px #3b82f6);
        }

        /* Modais */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            color: #ccc;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: white;
        }

        /* Templates */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .template-card {
            background: #333;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .template-name {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .template-description {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 10px;
        }

        .template-pieces {
            font-size: 12px;
            color: #888;
        }

        /* Visualiza√ß√£o 3D */
        .viewer-3d {
            width: 100%;
            height: 400px;
            background: #111;
            border-radius: 8px;
            position: relative;
        }

        .viewer-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .viewer-btn {
            background: rgba(0,0,0,0.7);
            border: 1px solid #444;
            color: white;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .viewer-btn:hover {
            background: rgba(0,0,0,0.9);
        }

        /* Responsividade */
        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 250px 1fr 280px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 1fr 30px;
            }
            
            .sidebar-left,
            .sidebar-right {
                position: fixed;
                top: 60px;
                bottom: 30px;
                width: 280px;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar-left.open {
                transform: translateX(0);
            }
            
            .sidebar-right {
                right: 0;
                transform: translateX(100%);
            }
            
            .sidebar-right.open {
                transform: translateX(0);
            }
            
            .header-tools {
                gap: 5px;
            }
            
            .header-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
        }

        /* Anima√ß√µes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Scrollbars customizadas */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #333;
            border: 1px solid #444;
            border-left: 4px solid #3b82f6;
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 2000;
            max-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left-color: #4ade80;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.warning {
            border-left-color: #f59e0b;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #444;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Grupos de pe√ßas */
        .piece-group {
            stroke: #f59e0b;
            stroke-width: 1;
            stroke-dasharray: 3,3;
            fill: none;
            pointer-events: none;
        }

        /* Medidas e cotas */
        .measurement-line {
            stroke: #4ade80;
            stroke-width: 1;
            marker-end: url(#arrowhead);
            marker-start: url(#arrowhead);
        }

        .measurement-text {
            fill: #4ade80;
            font-size: 12px;
            font-family: monospace;
            text-anchor: middle;
        }

        /* Alinhamento visual */
        .alignment-guide {
            stroke: #3b82f6;
            stroke-width: 1;
            stroke-dasharray: 2,2;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="currentColor">
                    <rect x="4" y="4" width="24" height="24" rx="2" fill="#3b82f6"/>
                    <rect x="8" y="8" width="16" height="16" rx="1" fill="white"/>
                    <circle cx="16" cy="16" r="4" fill="#3b82f6"/>
                </svg>
                <span>Otimizador Hidr√°ulico Pro</span>
                <span style="font-size: 12px; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 10px;">v3.0</span>
            </div>
            <div class="header-tools">
                <button class="header-btn" onclick="newProject()">üìÅ Novo</button>
                <button class="header-btn" onclick="openProject()">üìÇ Abrir</button>
                <button class="header-btn" onclick="saveProject()">üíæ Salvar</button>
                <button class="header-btn" onclick="showTemplates()">üìã Templates</button>
                <button class="header-btn" onclick="importDWG()">üì• DWG</button>
                <button class="header-btn" onclick="exportProject()">üì§ Exportar</button>
                <button class="header-btn" onclick="show3DViewer()">üéÆ 3D</button>
                <button class="header-btn" onclick="showBudget()">üí∞ Or√ßamento</button>
            </div>
        </header>

        <!-- Sidebar Esquerda - Biblioteca -->
        <aside class="sidebar-left">
            <div class="sidebar-title">
                üìö Biblioteca Tigre BIM
                <span style="font-size: 12px; color: #888;">(672 pe√ßas)</span>
            </div>
            
            <div class="category-filters">
                <button class="category-btn active" data-category="all">Todas</button>
                <button class="category-btn" data-category="esgoto">Esgoto</button>
                <button class="category-btn" data-category="irrigacao">Irriga√ß√£o</button>
                <button class="category-btn" data-category="soldavel">Sold√°vel</button>
                <button class="category-btn" data-category="caixa">Caixa D'√Ågua</button>
                <button class="category-btn" data-category="agua-fria">√Ågua Fria</button>
            </div>

            <div class="pieces-list" id="piecesList">
                <!-- Pe√ßas ser√£o carregadas dinamicamente -->
            </div>
        </aside>

        <!-- Canvas Central -->
        <main class="canvas-container">
            <div class="canvas-toolbar">
                <button class="tool-btn active" data-tool="select" title="Selecionar (S)">
                    ‚úã Selecionar
                </button>
                <button class="tool-btn" data-tool="move" title="Mover (M)">
                    ‚ÜîÔ∏è Mover
                </button>
                <button class="tool-btn" data-tool="rotate" title="Rotacionar (R)">
                    üîÑ Rotacionar
                </button>
                <button class="tool-btn" data-tool="copy" title="Copiar (C)">
                    üìã Copiar
                </button>
                <button class="tool-btn" data-tool="group" title="Agrupar (G)">
                    üì¶ Agrupar
                </button>
                <button class="tool-btn" data-tool="measure" title="Medir (T)">
                    üìê Medir
                </button>
                <button class="tool-btn" data-tool="align" title="Alinhar (A)">
                    üìè Alinhar
                </button>
                <button class="tool-btn" data-tool="delete" title="Excluir (Del)">
                    üóëÔ∏è Excluir
                </button>
                <div style="margin-left: auto; display: flex; gap: 10px;">
                    <button class="tool-btn" onclick="zoomIn()" title="Zoom In (+)">üîç+</button>
                    <button class="tool-btn" onclick="zoomOut()" title="Zoom Out (-)">üîç-</button>
                    <button class="tool-btn" onclick="fitToScreen()" title="Ajustar (F)">üìê</button>
                    <button class="tool-btn" data-tool="pan" title="Pan (P)">üëã</button>
                </div>
            </div>

            <div class="canvas-area">
                <svg class="canvas-svg" id="mainCanvas" viewBox="0 0 2000 1500">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                               refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#4ade80" />
                        </marker>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                            <feMerge> 
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <g id="canvasContent" transform="translate(0,0) scale(1)">
                        <!-- Pe√ßas ser√£o adicionadas aqui -->
                    </g>
                </svg>
                
                <div class="coordinates" id="coordinates">X: 0.00, Y: 0.00</div>
            </div>
        </main>

        <!-- Sidebar Direita - Propriedades -->
        <aside class="sidebar-right">
            <div class="properties-panel">
                <!-- Propriedades da Pe√ßa Selecionada -->
                <div class="panel-section">
                    <div class="panel-header">
                        üîß Propriedades
                    </div>
                    <div class="panel-content">
                        <div id="propertiesContent">
                            <p style="color: #888; text-align: center; padding: 20px;">
                                Nenhuma pe√ßa selecionada
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Layers -->
                <div class="panel-section">
                    <div class="panel-header">
                        üìä Layers
                    </div>
                    <div class="panel-content">
                        <div id="layersList">
                            <div class="layer-item">
                                <div class="layer-color" style="background: white;"></div>
                                <span class="layer-name">0 - Padr√£o</span>
                                <div class="layer-controls">
                                    <button class="layer-btn" title="Vis√≠vel">üëÅ</button>
                                    <button class="layer-btn" title="Desbloqueado">üîì</button>
                                </div>
                            </div>
                            <div class="layer-item">
                                <div class="layer-color" style="background: #ef4444;"></div>
                                <span class="layer-name">Esgoto</span>
                                <div class="layer-controls">
                                    <button class="layer-btn" title="Vis√≠vel">üëÅ</button>
                                    <button class="layer-btn" title="Desbloqueado">üîì</button>
                                </div>
                            </div>
                            <div class="layer-item">
                                <div class="layer-color" style="background: #3b82f6;"></div>
                                <span class="layer-name">√Ågua Fria</span>
                                <div class="layer-controls">
                                    <button class="layer-btn" title="Vis√≠vel">üëÅ</button>
                                    <button class="layer-btn" title="Desbloqueado">üîì</button>
                                </div>
                            </div>
                            <div class="layer-item">
                                <div class="layer-color" style="background: #4ade80;"></div>
                                <span class="layer-name">Irriga√ß√£o</span>
                                <div class="layer-controls">
                                    <button class="layer-btn" title="Vis√≠vel">üëÅ</button>
                                    <button class="layer-btn" title="Desbloqueado">üîì</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hist√≥rico -->
                <div class="panel-section">
                    <div class="panel-header">
                        ‚èÆÔ∏è Hist√≥rico
                        <span id="historyCounter" style="font-size: 12px; color: #888;">(0)</span>
                    </div>
                    <div class="panel-content">
                        <div id="historyList" style="max-height: 200px; overflow-y: auto;">
                            <p style="color: #888; text-align: center; padding: 10px; font-size: 12px;">
                                Nenhuma a√ß√£o realizada
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Lista de Materiais -->
                <div class="panel-section">
                    <div class="panel-header">
                        üìã Lista de Materiais
                        <span id="materialsCounter" style="font-size: 12px; color: #888;">(0)</span>
                    </div>
                    <div class="panel-content">
                        <div id="materialsList">
                            <p style="color: #888; text-align: center; padding: 10px; font-size: 12px;">
                                Nenhuma pe√ßa adicionada
                            </p>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
                            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                <span>Total:</span>
                                <span id="totalCost" style="color: #4ade80;">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="command-line">
                <span>Command:</span>
                <input type="text" class="command-input" id="commandInput" 
                       placeholder="Digite um comando..." autocomplete="off">
            </div>
            <div class="status-info">
                <div class="status-item">
                    <div class="status-indicator" id="snapIndicator"></div>
                    <span>Snap: <span id="snapStatus">ON</span></span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="gridIndicator"></div>
                    <span>Grid: <span id="gridStatus">ON</span></span>
                </div>
                <div class="status-item">
                    <div class="status-indicator off" id="orthoIndicator"></div>
                    <span>Ortho: <span id="orthoStatus">OFF</span></span>
                </div>
                <div class="status-item">
                    <span>Zoom: <span id="zoomLevel">100%</span></span>
                </div>
                <div class="status-item">
                    <span>Pe√ßas: <span id="pieceCount">0</span></span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modais -->
    
    <!-- Modal Templates -->
    <div class="modal" id="templatesModal">
        <div class="modal-content" style="width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">üìã Templates de Projeto</h3>
                <button class="modal-close" onclick="closeModal('templatesModal')">&times;</button>
            </div>
            <div class="template-grid">
                <div class="template-card" onclick="loadTemplate('banheiro')">
                    <div class="template-name">üöø Banheiro Completo</div>
                    <div class="template-description">Instala√ß√£o hidr√°ulica completa para banheiro residencial</div>
                    <div class="template-pieces">12 pe√ßas ‚Ä¢ R$ 245,80</div>
                </div>
                <div class="template-card" onclick="loadTemplate('cozinha')">
                    <div class="template-name">üçΩÔ∏è Cozinha Residencial</div>
                    <div class="template-description">Sistema de √°gua fria e esgoto para cozinha</div>
                    <div class="template-pieces">8 pe√ßas ‚Ä¢ R$ 156,40</div>
                </div>
                <div class="template-card" onclick="loadTemplate('area-servico')">
                    <div class="template-name">üß∫ √Årea de Servi√ßo</div>
                    <div class="template-description">Instala√ß√£o para lavanderia e √°rea de servi√ßo</div>
                    <div class="template-pieces">6 pe√ßas ‚Ä¢ R$ 98,60</div>
                </div>
                <div class="template-card" onclick="loadTemplate('irrigacao')">
                    <div class="template-name">üå± Sistema de Irriga√ß√£o</div>
                    <div class="template-description">Rede de irriga√ß√£o para jardim residencial</div>
                    <div class="template-pieces">15 pe√ßas ‚Ä¢ R$ 312,90</div>
                </div>
                <div class="template-card" onclick="loadTemplate('piscina')">
                    <div class="template-name">üèä Piscina Residencial</div>
                    <div class="template-description">Sistema hidr√°ulico completo para piscina</div>
                    <div class="template-pieces">20 pe√ßas ‚Ä¢ R$ 567,30</div>
                </div>
                <div class="template-card" onclick="loadTemplate('comercial')">
                    <div class="template-name">üè¢ Comercial B√°sico</div>
                    <div class="template-description">Instala√ß√£o hidr√°ulica para estabelecimento comercial</div>
                    <div class="template-pieces">25 pe√ßas ‚Ä¢ R$ 789,50</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Visualizador 3D -->
    <div class="modal" id="viewer3DModal">
        <div class="modal-content" style="width: 900px; height: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">üéÆ Visualizador 3D</h3>
                <button class="modal-close" onclick="closeModal('viewer3DModal')">&times;</button>
            </div>
            <div class="viewer-3d" id="viewer3D">
                <div class="viewer-controls">
                    <button class="viewer-btn" onclick="rotate3D()">üîÑ Rotacionar</button>
                    <button class="viewer-btn" onclick="reset3D()">üéØ Resetar</button>
                    <button class="viewer-btn" onclick="export3D()">üì§ Exportar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Or√ßamento -->
    <div class="modal" id="budgetModal">
        <div class="modal-content" style="width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">üí∞ Or√ßamento Detalhado</h3>
                <button class="modal-close" onclick="closeModal('budgetModal')">&times;</button>
            </div>
            <div id="budgetContent">
                <!-- Conte√∫do do or√ßamento ser√° gerado dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal Importa√ß√£o DWG -->
    <div class="modal" id="dwgModal">
        <div class="modal-content" style="width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">üì• Importar Arquivo DWG</h3>
                <button class="modal-close" onclick="closeModal('dwgModal')">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="border: 2px dashed #444; padding: 40px; text-align: center; margin-bottom: 20px; border-radius: 8px;">
                    <input type="file" id="dwgFileInput" accept=".dwg,.dxf" style="display: none;" onchange="processDWGFile(this)">
                    <button onclick="document.getElementById('dwgFileInput').click()" 
                            style="background: #3b82f6; border: none; color: white; padding: 12px 24px; border-radius: 6px; cursor: pointer;">
                        üìÅ Selecionar Arquivo DWG/DXF
                    </button>
                    <p style="margin-top: 10px; color: #888; font-size: 14px;">
                        Ou arraste o arquivo aqui
                    </p>
                </div>
                
                <div id="dwgBlocksList" style="display: none;">
                    <h4 style="margin-bottom: 15px;">Blocos Encontrados:</h4>
                    <div id="blocksContainer" style="max-height: 300px; overflow-y: auto;">
                        <!-- Blocos ser√£o listados aqui -->
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="importSelectedBlocks()" 
                                style="background: #4ade80; border: none; color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            ‚úÖ Importar Selecionados
                        </button>
                        <button onclick="closeModal('dwgModal')" 
                                style="background: #6b7280; border: none; color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado da aplica√ß√£o
        let appState = {
            currentTool: 'select',
            selectedPieces: [],
            pieces: [],
            history: [],
            historyIndex: -1,
            zoom: 1,
            pan: { x: 0, y: 0 },
            snapEnabled: true,
            gridEnabled: true,
            orthoEnabled: false,
            insertionMode: false,
            insertingPiece: null,
            groups: [],
            measurements: [],
            currentLayer: '0'
        };

        // Cat√°logo de pe√ßas Tigre BIM
        const pieceCatalog = [
            // Esgoto Redux
            {
                id: 'cap-esgoto-dn40',
                name: 'Cap Esgoto Redux DN40',
                code: '100002791',
                category: 'esgoto',
                price: 8.50,
                svg: `<g><circle cx="20" cy="20" r="15" fill="#e5e7eb" stroke="#9ca3af" stroke-width="2"/>
                      <circle cx="20" cy="20" r="10" fill="#f3f4f6" stroke="#6b7280"/>
                      <text x="20" y="25" text-anchor="middle" font-size="8" fill="#374151">40</text></g>`,
                width: 40,
                height: 40,
                snapPoints: [{ x: 20, y: 5 }, { x: 20, y: 35 }]
            },
            {
                id: 'joelho-90-dn100',
                name: 'Joelho 90¬∞ Redux DN100',
                code: '100002799',
                category: 'esgoto',
                price: 32.80,
                svg: `<g><path d="M5,35 Q5,5 35,5 L50,5 Q60,5 60,15 L60,30 Q60,40 50,40 L35,40 Q5,40 5,35 Z" 
                      fill="#8b5cf6" stroke="#7c3aed" stroke-width="2"/>
                      <circle cx="15" cy="25" r="3" fill="#6366f1"/>
                      <circle cx="45" cy="15" r="3" fill="#6366f1"/>
                      <text x="32" y="25" text-anchor="middle" font-size="8" fill="white">90¬∞</text></g>`,
                width: 65,
                height: 45,
                snapPoints: [{ x: 15, y: 25 }, { x: 45, y: 15 }]
            },
            {
                id: 'te-90-dn100',
                name: 'T√™ 90¬∞ Redux DN100',
                code: '100002804',
                category: 'esgoto',
                price: 45.60,
                svg: `<g><rect x="5" y="20" width="50" height="10" rx="5" fill="#e5e7eb" stroke="#9ca3af" stroke-width="2"/>
                      <rect x="25" y="5" width="10" height="30" rx="5" fill="#e5e7eb" stroke="#9ca3af" stroke-width="2"/>
                      <circle cx="10" cy="25" r="3" fill="#3b82f6"/>
                      <circle cx="50" cy="25" r="3" fill="#3b82f6"/>
                      <circle cx="30" cy="10" r="3" fill="#3b82f6"/>
                      <text x="30" y="28" text-anchor="middle" font-size="6" fill="#374151">100</text></g>`,
                width: 60,
                height: 40,
                snapPoints: [{ x: 10, y: 25 }, { x: 50, y: 25 }, { x: 30, y: 10 }]
            },
            {
                id: 'tubo-dn100-6m',
                name: 'Tubo Redux DN100 6M',
                code: '100002789',
                category: 'esgoto',
                price: 48.90,
                svg: `<g><rect x="5" y="15" width="120" height="20" rx="10" fill="#f3f4f6" stroke="#d1d5db" stroke-width="2"/>
                      <rect x="10" y="18" width="110" height="14" rx="7" fill="white"/>
                      <circle cx="15" cy="25" r="4" fill="#3b82f6"/>
                      <circle cx="115" cy="25" r="4" fill="#3b82f6"/>
                      <text x="65" y="28" text-anchor="middle" font-size="8" fill="#374151">DN100 - 6M</text></g>`,
                width: 130,
                height: 50,
                snapPoints: [{ x: 15, y: 25 }, { x: 115, y: 25 }]
            },
            {
                id: 'torneira-boia-12',
                name: 'Torneira Boia 1/2"',
                code: '100002305',
                category: 'caixa',
                price: 35.80,
                svg: `<g><rect x="10" y="15" width="40" height="20" rx="5" fill="#22c55e" stroke="#16a34a" stroke-width="2"/>
                      <circle cx="50" cy="25" r="8" fill="#fbbf24" stroke="#f59e0b" stroke-width="2"/>
                      <rect x="5" y="22" width="10" height="6" rx="3" fill="#6b7280"/>
                      <line x1="58" y1="25" x2="70" y2="15" stroke="#374151" stroke-width="3"/>
                      <circle cx="70" cy="15" r="4" fill="#ef4444"/>
                      <text x="30" y="28" text-anchor="middle" font-size="6" fill="white">1/2"</text></g>`,
                width: 75,
                height: 40,
                snapPoints: [{ x: 10, y: 25 }]
            },
            // Irriga√ß√£o
            {
                id: 'joelho-90-irrigacao',
                name: 'Joelho 90¬∞ Irriga√ß√£o DN50',
                code: '100003001',
                category: 'irrigacao',
                price: 15.20,
                svg: `<g><path d="M5,30 Q5,5 30,5 L40,5 Q50,5 50,15 L50,25 Q50,35 40,35 L30,35 Q5,35 5,30 Z" 
                      fill="#3b82f6" stroke="#2563eb" stroke-width="2"/>
                      <circle cx="12" cy="22" r="2" fill="#1d4ed8"/>
                      <circle cx="38" cy="12" r="2" fill="#1d4ed8"/>
                      <text x="27" y="22" text-anchor="middle" font-size="6" fill="white">50</text></g>`,
                width: 55,
                height: 40,
                snapPoints: [{ x: 12, y: 22 }, { x: 38, y: 12 }]
            },
            {
                id: 'te-irrigacao-dn50',
                name: 'T√™ Irriga√ß√£o DN50',
                code: '100003015',
                category: 'irrigacao',
                price: 28.40,
                svg: `<g><rect x="5" y="18" width="40" height="8" rx="4" fill="#3b82f6" stroke="#2563eb" stroke-width="2"/>
                      <rect x="21" y="5" width="8" height="26" rx="4" fill="#3b82f6" stroke="#2563eb" stroke-width="2"/>
                      <circle cx="9" cy="22" r="2" fill="#1e40af"/>
                      <circle cx="41" cy="22" r="2" fill="#1e40af"/>
                      <circle cx="25" cy="9" r="2" fill="#1e40af"/>
                      <text x="25" y="24" text-anchor="middle" font-size="5" fill="white">50</text></g>`,
                width: 50,
                height: 36,
                snapPoints: [{ x: 9, y: 22 }, { x: 41, y: 22 }, { x: 25, y: 9 }]
            },
            // Sold√°vel
            {
                id: 'joelho-45-soldavel',
                name: 'Joelho 45¬∞ Sold√°vel DN75',
                code: '100004020',
                category: 'soldavel',
                price: 22.30,
                svg: `<g><path d="M8,32 Q15,15 32,8 L42,13 Q52,18 52,28 L47,38 Q42,48 32,48 L22,43 Q8,38 8,32 Z" 
                      fill="#f97316" stroke="#ea580c" stroke-width="2"/>
                      <circle cx="15" cy="25" r="2" fill="#dc2626"/>
                      <circle cx="35" cy="15" r="2" fill="#dc2626"/>
                      <text x="28" y="30" text-anchor="middle" font-size="6" fill="white">45¬∞</text></g>`,
                width: 60,
                height: 56,
                snapPoints: [{ x: 15, y: 25 }, { x: 35, y: 15 }]
            },
            {
                id: 'reducao-100x75',
                name: 'Redu√ß√£o Sold√°vel 100x75mm',
                code: '100004055',
                category: 'soldavel',
                price: 18.90,
                svg: `<g><path d="M10,15 L50,15 L45,35 L15,35 Z" fill="#f97316" stroke="#ea580c" stroke-width="2"/>
                      <circle cx="15" cy="25" r="3" fill="#dc2626"/>
                      <circle cx="45" cy="25" r="2" fill="#dc2626"/>
                      <text x="30" y="27" text-anchor="middle" font-size="6" fill="white">100x75</text></g>`,
                width: 60,
                height: 50,
                snapPoints: [{ x: 15, y: 25 }, { x: 45, y: 25 }]
            },
            // √Ågua Fria
            {
                id: 'joelho-90-agua-fria',
                name: 'Joelho 90¬∞ √Ågua Fria DN25',
                code: '100005010',
                category: 'agua-fria',
                price: 12.80,
                svg: `<g><path d="M5,25 Q5,5 25,5 L30,5 Q40,5 40,15 L40,20 Q40,30 30,30 L25,30 Q5,30 5,25 Z" 
                      fill="#0ea5e9" stroke="#0284c7" stroke-width="2"/>
                      <circle cx="10" cy="20" r="2" fill="#0369a1"/>
                      <circle cx="30" cy="10" r="2" fill="#0369a1"/>
                      <text x="22" y="20" text-anchor="middle" font-size="5" fill="white">25</text></g>`,
                width: 45,
                height: 35,
                snapPoints: [{ x: 10, y: 20 }, { x: 30, y: 10 }]
            },
            {
                id: 'te-agua-fria-dn25',
                name: 'T√™ √Ågua Fria DN25',
                code: '100005025',
                category: 'agua-fria',
                price: 19.60,
                svg: `<g><rect x="5" y="16" width="35" height="6" rx="3" fill="#0ea5e9" stroke="#0284c7" stroke-width="2"/>
                      <rect x="19" y="5" width="6" height="22" rx="3" fill="#0ea5e9" stroke="#0284c7" stroke-width="2"/>
                      <circle cx="8" cy="19" r="1.5" fill="#0369a1"/>
                      <circle cx="37" cy="19" r="1.5" fill="#0369a1"/>
                      <circle cx="22" cy="8" r="1.5" fill="#0369a1"/>
                      <text x="22" y="21" text-anchor="middle" font-size="4" fill="white">25</text></g>`,
                width: 45,
                height: 32,
                snapPoints: [{ x: 8, y: 19 }, { x: 37, y: 19 }, { x: 22, y: 8 }]
            }
        ];

        // Templates de projeto
        const projectTemplates = {
            'banheiro': {
                name: 'Banheiro Completo',
                pieces: [
                    { id: 'joelho-90-dn100', x: 100, y: 100, rotation: 0 },
                    { id: 'te-90-dn100', x: 200, y: 100, rotation: 0 },
                    { id: 'tubo-dn100-6m', x: 300, y: 100, rotation: 0 },
                    { id: 'cap-esgoto-dn40', x: 100, y: 200, rotation: 0 },
                    { id: 'joelho-90-agua-fria', x: 200, y: 200, rotation: 0 },
                    { id: 'te-agua-fria-dn25', x: 300, y: 200, rotation: 0 }
                ]
            },
            'cozinha': {
                name: 'Cozinha Residencial',
                pieces: [
                    { id: 'te-90-dn100', x: 150, y: 150, rotation: 0 },
                    { id: 'joelho-90-dn100', x: 250, y: 150, rotation: 0 },
                    { id: 'tubo-dn100-6m', x: 350, y: 150, rotation: 0 },
                    { id: 'joelho-90-agua-fria', x: 150, y: 250, rotation: 0 }
                ]
            },
            'area-servico': {
                name: '√Årea de Servi√ßo',
                pieces: [
                    { id: 'joelho-90-dn100', x: 200, y: 200, rotation: 0 },
                    { id: 'te-90-dn100', x: 300, y: 200, rotation: 0 },
                    { id: 'cap-esgoto-dn40', x: 400, y: 200, rotation: 0 }
                ]
            },
            'irrigacao': {
                name: 'Sistema de Irriga√ß√£o',
                pieces: [
                    { id: 'joelho-90-irrigacao', x: 100, y: 300, rotation: 0 },
                    { id: 'te-irrigacao-dn50', x: 200, y: 300, rotation: 0 },
                    { id: 'joelho-90-irrigacao', x: 300, y: 300, rotation: 90 },
                    { id: 'te-irrigacao-dn50', x: 400, y: 300, rotation: 0 }
                ]
            },
            'piscina': {
                name: 'Piscina Residencial',
                pieces: [
                    { id: 'joelho-90-irrigacao', x: 150, y: 400, rotation: 0 },
                    { id: 'te-irrigacao-dn50', x: 250, y: 400, rotation: 0 },
                    { id: 'joelho-90-irrigacao', x: 350, y: 400, rotation: 0 },
                    { id: 'reducao-100x75', x: 450, y: 400, rotation: 0 }
                ]
            },
            'comercial': {
                name: 'Comercial B√°sico',
                pieces: [
                    { id: 'tubo-dn100-6m', x: 200, y: 500, rotation: 0 },
                    { id: 'te-90-dn100', x: 350, y: 500, rotation: 0 },
                    { id: 'joelho-90-dn100', x: 500, y: 500, rotation: 0 }
                ]
            }
        };

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadPiecesCatalog();
            setupEventListeners();
            setupKeyboardShortcuts();
            setupCanvasEvents();
            updateStatusBar();
            
            // Registrar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZnVuY3Rpb24oZXZlbnQpIHsgZXZlbnQud2FpdFVudGlsKHNlbGYuc2tpcFdhaXRpbmcoKSk7IH0pOw==');
            }
            
            showToast('Aplicativo carregado com sucesso!', 'success');
        });

        function initializeApp() {
            // Configura√ß√µes iniciais
            appState.pieces = [];
            appState.selectedPieces = [];
            appState.history = [];
            appState.historyIndex = -1;
            
            // Carregar dados salvos
            const savedData = localStorage.getItem('hydraulicOptimizer');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.pieces) {
                        appState.pieces = data.pieces;
                        renderCanvas();
                        updateMaterialsList();
                    }
                } catch (e) {
                    console.warn('Erro ao carregar dados salvos:', e);
                }
            }
        }

        function loadPiecesCatalog() {
            const piecesList = document.getElementById('piecesList');
            piecesList.innerHTML = '';
            
            pieceCatalog.forEach(piece => {
                const pieceElement = document.createElement('div');
                pieceElement.className = 'piece-item';
                pieceElement.dataset.pieceId = piece.id;
                pieceElement.dataset.category = piece.category;
                
                pieceElement.innerHTML = `
                    <svg class="piece-icon" viewBox="0 0 80 80">
                        ${piece.svg}
                    </svg>
                    <div class="piece-info">
                        <div class="piece-name">${piece.name}</div>
                        <div class="piece-code">${piece.code}</div>
                        <div class="piece-price">R$ ${piece.price.toFixed(2)}</div>
                    </div>
                `;
                
                // Duplo clique para iniciar inser√ß√£o
                pieceElement.addEventListener('dblclick', () => {
                    startInsertion(piece);
                });
                
                piecesList.appendChild(pieceElement);
            });
        }

        function setupEventListeners() {
            // Filtros de categoria
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    filterPiecesByCategory(btn.dataset.category);
                });
            });

            // Ferramentas
            document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                btn.addEventListener('click', () => {
                    setActiveTool(btn.dataset.tool);
                });
            });

            // Linha de comando
            document.getElementById('commandInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    executeCommand(e.target.value);
                    e.target.value = '';
                }
            });

            // Coordenadas do mouse
            document.getElementById('mainCanvas').addEventListener('mousemove', updateCoordinates);
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT') return;
                
                switch (e.key.toLowerCase()) {
                    case 's':
                        e.preventDefault();
                        setActiveTool('select');
                        break;
                    case 'm':
                        e.preventDefault();
                        setActiveTool('move');
                        break;
                    case 'r':
                        e.preventDefault();
                        setActiveTool('rotate');
                        break;
                    case 'c':
                        e.preventDefault();
                        if (e.ctrlKey) return; // Permitir Ctrl+C
                        setActiveTool('copy');
                        break;
                    case 'g':
                        e.preventDefault();
                        setActiveTool('group');
                        break;
                    case 't':
                        e.preventDefault();
                        setActiveTool('measure');
                        break;
                    case 'a':
                        e.preventDefault();
                        setActiveTool('align');
                        break;
                    case 'p':
                        e.preventDefault();
                        setActiveTool('pan');
                        break;
                    case 'delete':
                    case 'backspace':
                        e.preventDefault();
                        deleteSelectedPieces();
                        break;
                    case '+':
                    case '=':
                        e.preventDefault();
                        zoomIn();
                        break;
                    case '-':
                        e.preventDefault();
                        zoomOut();
                        break;
                    case 'f':
                        e.preventDefault();
                        fitToScreen();
                        break;
                    case 'escape':
                        e.preventDefault();
                        cancelCurrentOperation();
                        break;
                    case 'z':
                        if (e.ctrlKey) {
                            e.preventDefault();
                            if (e.shiftKey) {
                                redo();
                            } else {
                                undo();
                            }
                        }
                        break;
                }
            });
        }

        function setupCanvasEvents() {
            const canvas = document.getElementById('mainCanvas');
            let isDragging = false;
            let dragStart = null;
            let lastPan = { x: 0, y: 0 };

            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) / appState.zoom - appState.pan.x;
                const y = (e.clientY - rect.top) / appState.zoom - appState.pan.y;

                if (appState.insertionMode) {
                    insertPieceAtPosition(x, y);
                    return;
                }

                if (appState.currentTool === 'pan') {
                    isDragging = true;
                    dragStart = { x: e.clientX, y: e.clientY };
                    lastPan = { ...appState.pan };
                    canvas.classList.add('panning');
                    return;
                }

                // Verificar clique em pe√ßa
                const clickedPiece = findPieceAtPosition(x, y);
                if (clickedPiece) {
                    handlePieceClick(clickedPiece, e);
                } else {
                    // Clique no canvas vazio
                    if (!e.ctrlKey) {
                        clearSelection();
                    }
                }
            });

            canvas.addEventListener('mousemove', (e) => {
                if (appState.insertionMode && appState.insertingPiece) {
                    updateInsertionPreview(e);
                }

                if (isDragging && appState.currentTool === 'pan') {
                    const deltaX = (e.clientX - dragStart.x) / appState.zoom;
                    const deltaY = (e.clientY - dragStart.y) / appState.zoom;
                    
                    appState.pan.x = lastPan.x + deltaX;
                    appState.pan.y = lastPan.y + deltaY;
                    
                    updateCanvasTransform();
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
                canvas.classList.remove('panning');
            });

            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                zoomAtPoint(delta, mouseX, mouseY);
            });

            // Eventos touch para mobile
            let touchStart = null;
            let initialDistance = 0;
            let initialZoom = 1;

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                
                if (e.touches.length === 1) {
                    touchStart = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY
                    };
                } else if (e.touches.length === 2) {
                    // Pinch to zoom
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    initialDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    initialZoom = appState.zoom;
                }
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                
                if (e.touches.length === 1 && touchStart) {
                    // Pan
                    const deltaX = (e.touches[0].clientX - touchStart.x) / appState.zoom;
                    const deltaY = (e.touches[0].clientY - touchStart.y) / appState.zoom;
                    
                    appState.pan.x += deltaX * 0.5;
                    appState.pan.y += deltaY * 0.5;
                    
                    touchStart = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY
                    };
                    
                    updateCanvasTransform();
                } else if (e.touches.length === 2) {
                    // Zoom
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];
                    const currentDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    
                    const scale = currentDistance / initialDistance;
                    appState.zoom = Math.max(0.1, Math.min(5, initialZoom * scale));
                    
                    updateCanvasTransform();
                    updateStatusBar();
                }
            });

            canvas.addEventListener('touchend', () => {
                touchStart = null;
            });
        }

        function startInsertion(piece) {
            appState.insertionMode = true;
            appState.insertingPiece = piece;
            
            // Destacar pe√ßa na lista
            document.querySelectorAll('.piece-item').forEach(item => {
                item.classList.remove('inserting');
            });
            document.querySelector(`[data-piece-id="${piece.id}"]`).classList.add('inserting');
            
            // Mudar cursor
            document.getElementById('mainCanvas').style.cursor = 'crosshair';
            
            showToast(`Modo inser√ß√£o ativo: ${piece.name}`, 'info');
        }

        function updateInsertionPreview(e) {
            if (!appState.insertionMode || !appState.insertingPiece) return;
            
            const canvas = document.getElementById('mainCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / appState.zoom - appState.pan.x;
            const y = (e.clientY - rect.top) / appState.zoom - appState.pan.y;
            
            // Remover preview anterior
            const existingPreview = document.querySelector('.insertion-preview');
            if (existingPreview) {
                existingPreview.remove();
            }
            
            // Criar novo preview
            const preview = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            preview.classList.add('insertion-preview');
            preview.innerHTML = appState.insertingPiece.svg;
            preview.setAttribute('transform', `translate(${x}, ${y})`);
            
            document.getElementById('canvasContent').appendChild(preview);
            
            // Mostrar pontos de snap pr√≥ximos
            showNearbySnapPoints(x, y);
        }

        function insertPieceAtPosition(x, y) {
            if (!appState.insertingPiece) return;
            
            // Aplicar snap se habilitado
            if (appState.snapEnabled) {
                const snapPoint = findNearestSnapPoint(x, y);
                if (snapPoint) {
                    x = snapPoint.x;
                    y = snapPoint.y;
                }
            }
            
            const newPiece = {
                id: generateId(),
                type: appState.insertingPiece.id,
                name: appState.insertingPiece.name,
                x: x,
                y: y,
                rotation: 0,
                layer: appState.currentLayer,
                selected: false
            };
            
            appState.pieces.push(newPiece);
            
            // Adicionar ao hist√≥rico
            addToHistory(`Inserir ${appState.insertingPiece.name}`);
            
            // Renderizar canvas
            renderCanvas();
            updateMaterialsList();
            updateStatusBar();
            
            // Salvar automaticamente
            saveProject();
            
            showToast(`${appState.insertingPiece.name} inserida`, 'success');
            
            // Continuar inser√ß√£o se Shift estiver pressionado
            if (!event.shiftKey) {
                cancelCurrentOperation();
            }
        }

        function cancelCurrentOperation() {
            appState.insertionMode = false;
            appState.insertingPiece = null;
            
            // Remover destaque da pe√ßa
            document.querySelectorAll('.piece-item').forEach(item => {
                item.classList.remove('inserting');
            });
            
            // Remover preview
            const preview = document.querySelector('.insertion-preview');
            if (preview) {
                preview.remove();
            }
            
            // Restaurar cursor
            document.getElementById('mainCanvas').style.cursor = 'crosshair';
            
            // Ocultar pontos de snap
            hideSnapPoints();
        }

        function renderCanvas() {
            const canvasContent = document.getElementById('canvasContent');
            
            // Limpar conte√∫do anterior (exceto preview)
            const elementsToRemove = canvasContent.querySelectorAll(':not(.insertion-preview)');
            elementsToRemove.forEach(el => el.remove());
            
            // Renderizar pe√ßas
            appState.pieces.forEach(piece => {
                const pieceData = pieceCatalog.find(p => p.id === piece.type);
                if (!pieceData) return;
                
                const pieceElement = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                pieceElement.classList.add('canvas-piece');
                pieceElement.dataset.pieceId = piece.id;
                
                if (piece.selected) {
                    pieceElement.classList.add('selected');
                }
                
                pieceElement.innerHTML = pieceData.svg;
                pieceElement.setAttribute('transform', 
                    `translate(${piece.x}, ${piece.y}) rotate(${piece.rotation})`);
                
                canvasContent.appendChild(pieceElement);
                
                // Renderizar pontos de snap da pe√ßa
                if (pieceData.snapPoints && appState.snapEnabled) {
                    pieceData.snapPoints.forEach(snapPoint => {
                        const snapElement = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        snapElement.classList.add('snap-point');
                        snapElement.setAttribute('cx', piece.x + snapPoint.x);
                        snapElement.setAttribute('cy', piece.y + snapPoint.y);
                        snapElement.setAttribute('r', '3');
                        
                        canvasContent.appendChild(snapElement);
                    });
                }
            });
            
            // Renderizar grupos
            appState.groups.forEach(group => {
                if (group.pieces.length > 1) {
                    const groupBounds = calculateGroupBounds(group.pieces);
                    const groupElement = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    groupElement.classList.add('piece-group');
                    groupElement.setAttribute('x', groupBounds.x - 5);
                    groupElement.setAttribute('y', groupBounds.y - 5);
                    groupElement.setAttribute('width', groupBounds.width + 10);
                    groupElement.setAttribute('height', groupBounds.height + 10);
                    
                    canvasContent.appendChild(groupElement);
                }
            });
            
            // Renderizar medidas
            appState.measurements.forEach(measurement => {
                renderMeasurement(measurement);
            });
        }

        function updateCanvasTransform() {
            const canvasContent = document.getElementById('canvasContent');
            canvasContent.setAttribute('transform', 
                `translate(${appState.pan.x}, ${appState.pan.y}) scale(${appState.zoom})`);
        }

        function updateCoordinates(e) {
            const canvas = document.getElementById('mainCanvas');
            const rect = canvas.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / appState.zoom - appState.pan.x).toFixed(2);
            const y = ((e.clientY - rect.top) / appState.zoom - appState.pan.y).toFixed(2);
            
            document.getElementById('coordinates').textContent = `X: ${x}, Y: ${y}`;
        }

        function updateStatusBar() {
            document.getElementById('snapStatus').textContent = appState.snapEnabled ? 'ON' : 'OFF';
            document.getElementById('snapIndicator').className = 
                `status-indicator ${appState.snapEnabled ? '' : 'off'}`;
            
            document.getElementById('gridStatus').textContent = appState.gridEnabled ? 'ON' : 'OFF';
            document.getElementById('gridIndicator').className = 
                `status-indicator ${appState.gridEnabled ? '' : 'off'}`;
            
            document.getElementById('orthoStatus').textContent = appState.orthoEnabled ? 'ON' : 'OFF';
            document.getElementById('orthoIndicator').className = 
                `status-indicator ${appState.orthoEnabled ? '' : 'off'}`;
            
            document.getElementById('zoomLevel').textContent = `${Math.round(appState.zoom * 100)}%`;
            document.getElementById('pieceCount').textContent = appState.pieces.length;
        }

        function updateMaterialsList() {
            const materialsList = document.getElementById('materialsList');
            const materialsCounter = document.getElementById('materialsCounter');
            const totalCostElement = document.getElementById('totalCost');
            
            if (appState.pieces.length === 0) {
                materialsList.innerHTML = '<p style="color: #888; text-align: center; padding: 10px; font-size: 12px;">Nenhuma pe√ßa adicionada</p>';
                materialsCounter.textContent = '(0)';
                totalCostElement.textContent = 'R$ 0,00';
                return;
            }
            
            // Agrupar pe√ßas por tipo
            const groupedPieces = {};
            let totalCost = 0;
            
            appState.pieces.forEach(piece => {
                const pieceData = pieceCatalog.find(p => p.id === piece.type);
                if (!pieceData) return;
                
                if (!groupedPieces[piece.type]) {
                    groupedPieces[piece.type] = {
                        data: pieceData,
                        count: 0,
                        cost: 0
                    };
                }
                
                groupedPieces[piece.type].count++;
                groupedPieces[piece.type].cost += pieceData.price;
                totalCost += pieceData.price;
            });
            
            // Renderizar lista
            materialsList.innerHTML = '';
            Object.values(groupedPieces).forEach(group => {
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #444; font-size: 12px;';
                
                item.innerHTML = `
                    <div>
                        <div style="font-weight: bold;">${group.data.name}</div>
                        <div style="color: #888; font-size: 10px;">${group.data.code}</div>
                    </div>
                    <div style="text-align: right;">
                        <div>${group.count}x</div>
                        <div style="color: #4ade80; font-weight: bold;">R$ ${group.cost.toFixed(2)}</div>
                    </div>
                `;
                
                materialsList.appendChild(item);
            });
            
            materialsCounter.textContent = `(${appState.pieces.length})`;
            totalCostElement.textContent = `R$ ${totalCost.toFixed(2)}`;
        }

        function updateHistoryList() {
            const historyList = document.getElementById('historyList');
            const historyCounter = document.getElementById('historyCounter');
            
            if (appState.history.length === 0) {
                historyList.innerHTML = '<p style="color: #888; text-align: center; padding: 10px; font-size: 12px;">Nenhuma a√ß√£o realizada</p>';
                historyCounter.textContent = '(0)';
                return;
            }
            
            historyList.innerHTML = '';
            appState.history.forEach((action, index) => {
                const item = document.createElement('div');
                item.style.cssText = `padding: 5px 0; font-size: 11px; color: ${index <= appState.historyIndex ? '#ccc' : '#666'}; cursor: pointer;`;
                item.textContent = `${index + 1}. ${action.description}`;
                
                item.addEventListener('click', () => {
                    goToHistoryState(index);
                });
                
                historyList.appendChild(item);
            });
            
            historyCounter.textContent = `(${appState.history.length})`;
        }

        function updatePropertiesPanel() {
            const propertiesContent = document.getElementById('propertiesContent');
            
            if (appState.selectedPieces.length === 0) {
                propertiesContent.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">Nenhuma pe√ßa selecionada</p>';
                return;
            }
            
            if (appState.selectedPieces.length === 1) {
                const piece = appState.selectedPieces[0];
                const pieceData = pieceCatalog.find(p => p.id === piece.type);
                
                propertiesContent.innerHTML = `
                    <div class="property-group">
                        <label class="property-label">Nome</label>
                        <input type="text" class="property-input" value="${piece.name}" readonly>
                    </div>
                    <div class="property-group">
                        <label class="property-label">C√≥digo</label>
                        <input type="text" class="property-input" value="${pieceData?.code || ''}" readonly>
                    </div>
                    <div class="property-group">
                        <label class="property-label">Posi√ß√£o X</label>
                        <input type="number" class="property-input" value="${piece.x.toFixed(2)}" 
                               onchange="updatePieceProperty('${piece.id}', 'x', parseFloat(this.value))">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Posi√ß√£o Y</label>
                        <input type="number" class="property-input" value="${piece.y.toFixed(2)}" 
                               onchange="updatePieceProperty('${piece.id}', 'y', parseFloat(this.value))">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Rota√ß√£o</label>
                        <input type="number" class="property-input" value="${piece.rotation}" 
                               onchange="updatePieceProperty('${piece.id}', 'rotation', parseFloat(this.value))">
                    </div>
                    <div class="property-group">
                        <label class="property-label">Layer</label>
                        <select class="property-input" onchange="updatePieceProperty('${piece.id}', 'layer', this.value)">
                            <option value="0" ${piece.layer === '0' ? 'selected' : ''}>0 - Padr√£o</option>
                            <option value="Esgoto" ${piece.layer === 'Esgoto' ? 'selected' : ''}>Esgoto</option>
                            <option value="√Ågua Fria" ${piece.layer === '√Ågua Fria' ? 'selected' : ''}>√Ågua Fria</option>
                            <option value="Irriga√ß√£o" ${piece.layer === 'Irriga√ß√£o' ? 'selected' : ''}>Irriga√ß√£o</option>
                        </select>
                    </div>
                    <div class="property-group">
                        <label class="property-label">Pre√ßo</label>
                        <input type="text" class="property-input" value="R$ ${pieceData?.price.toFixed(2) || '0,00'}" readonly>
                    </div>
                `;
            } else {
                propertiesContent.innerHTML = `
                    <p style="color: #888; text-align: center; padding: 20px;">
                        ${appState.selectedPieces.length} pe√ßas selecionadas
                    </p>
                    <div class="property-group">
                        <button onclick="alignSelectedPieces('left')" style="width: 100%; margin-bottom: 5px; background: #444; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; cursor: pointer;">
                            Alinhar √† Esquerda
                        </button>
                        <button onclick="alignSelectedPieces('center')" style="width: 100%; margin-bottom: 5px; background: #444; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; cursor: pointer;">
                            Alinhar ao Centro
                        </button>
                        <button onclick="alignSelectedPieces('right')" style="width: 100%; margin-bottom: 5px; background: #444; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; cursor: pointer;">
                            Alinhar √† Direita
                        </button>
                        <button onclick="distributeSelectedPieces('horizontal')" style="width: 100%; margin-bottom: 5px; background: #444; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; cursor: pointer;">
                            Distribuir Horizontalmente
                        </button>
                        <button onclick="distributeSelectedPieces('vertical')" style="width: 100%; background: #444; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; cursor: pointer;">
                            Distribuir Verticalmente
                        </button>
                    </div>
                `;
            }
        }

        // Fun√ß√µes de ferramentas
        function setActiveTool(tool) {
            appState.currentTool = tool;
            
            // Atualizar UI
            document.querySelectorAll('.tool-btn[data-tool]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tool="${tool}"]`)?.classList.add('active');
            
            // Cancelar opera√ß√£o atual se necess√°rio
            if (appState.insertionMode) {
                cancelCurrentOperation();
            }
            
            showToast(`Ferramenta ativa: ${tool}`, 'info');
        }

        function filterPiecesByCategory(category) {
            const pieces = document.querySelectorAll('.piece-item');
            
            pieces.forEach(piece => {
                if (category === 'all' || piece.dataset.category === category) {
                    piece.style.display = 'flex';
                } else {
                    piece.style.display = 'none';
                }
            });
        }

        function executeCommand(command) {
            const cmd = command.toLowerCase().trim();
            
            switch (cmd) {
                case 'zoom':
                case 'z':
                    fitToScreen();
                    break;
                case 'select':
                case 'sel':
                    setActiveTool('select');
                    break;
                case 'move':
                case 'mv':
                    setActiveTool('move');
                    break;
                case 'rotate':
                case 'rot':
                    setActiveTool('rotate');
                    break;
                case 'copy':
                case 'cp':
                    setActiveTool('copy');
                    break;
                case 'delete':
                case 'del':
                case 'erase':
                    deleteSelectedPieces();
                    break;
                case 'grid':
                    toggleGrid();
                    break;
                case 'snap':
                    toggleSnap();
                    break;
                case 'clear':
                    if (confirm('Limpar todo o canvas?')) {
                        clearCanvas();
                    }
                    break;
                default:
                    showToast(`Comando n√£o reconhecido: ${command}`, 'error');
            }
        }

        // Fun√ß√µes de zoom e navega√ß√£o
        function zoomIn() {
            appState.zoom = Math.min(5, appState.zoom * 1.2);
            updateCanvasTransform();
            updateStatusBar();
        }

        function zoomOut() {
            appState.zoom = Math.max(0.1, appState.zoom / 1.2);
            updateCanvasTransform();
            updateStatusBar();
        }

        function zoomAtPoint(delta, mouseX, mouseY) {
            const oldZoom = appState.zoom;
            appState.zoom = Math.max(0.1, Math.min(5, appState.zoom * delta));
            
            if (appState.zoom !== oldZoom) {
                const zoomRatio = appState.zoom / oldZoom;
                appState.pan.x = mouseX / appState.zoom - (mouseX / oldZoom - appState.pan.x) * zoomRatio;
                appState.pan.y = mouseY / appState.zoom - (mouseY / oldZoom - appState.pan.y) * zoomRatio;
                
                updateCanvasTransform();
                updateStatusBar();
            }
        }

        function fitToScreen() {
            if (appState.pieces.length === 0) {
                appState.zoom = 1;
                appState.pan = { x: 0, y: 0 };
            } else {
                const bounds = calculateBounds(appState.pieces);
                const canvas = document.getElementById('mainCanvas');
                const rect = canvas.getBoundingClientRect();
                
                const scaleX = rect.width / (bounds.width + 100);
                const scaleY = rect.height / (bounds.height + 100);
                appState.zoom = Math.min(scaleX, scaleY, 2);
                
                appState.pan.x = (rect.width / appState.zoom - bounds.width) / 2 - bounds.x;
                appState.pan.y = (rect.height / appState.zoom - bounds.height) / 2 - bounds.y;
            }
            
            updateCanvasTransform();
            updateStatusBar();
        }

        // Fun√ß√µes de sele√ß√£o e manipula√ß√£o
        function findPieceAtPosition(x, y) {
            for (let i = appState.pieces.length - 1; i >= 0; i--) {
                const piece = appState.pieces[i];
                const pieceData = pieceCatalog.find(p => p.id === piece.type);
                if (!pieceData) continue;
                
                const bounds = {
                    x: piece.x,
                    y: piece.y,
                    width: pieceData.width,
                    height: pieceData.height
                };
                
                if (x >= bounds.x && x <= bounds.x + bounds.width &&
                    y >= bounds.y && y <= bounds.y + bounds.height) {
                    return piece;
                }
            }
            return null;
        }

        function handlePieceClick(piece, event) {
            if (event.ctrlKey) {
                // Sele√ß√£o m√∫ltipla
                togglePieceSelection(piece);
            } else {
                // Sele√ß√£o √∫nica
                clearSelection();
                selectPiece(piece);
            }
            
            updatePropertiesPanel();
            renderCanvas();
        }

        function selectPiece(piece) {
            piece.selected = true;
            if (!appState.selectedPieces.includes(piece)) {
                appState.selectedPieces.push(piece);
            }
        }

        function togglePieceSelection(piece) {
            if (piece.selected) {
                piece.selected = false;
                appState.selectedPieces = appState.selectedPieces.filter(p => p !== piece);
            } else {
                selectPiece(piece);
            }
        }

        function clearSelection() {
            appState.selectedPieces.forEach(piece => {
                piece.selected = false;
            });
            appState.selectedPieces = [];
        }

        function deleteSelectedPieces() {
            if (appState.selectedPieces.length === 0) return;
            
            const deletedCount = appState.selectedPieces.length;
            appState.pieces = appState.pieces.filter(piece => !piece.selected);
            appState.selectedPieces = [];
            
            addToHistory(`Excluir ${deletedCount} pe√ßa(s)`);
            renderCanvas();
            updateMaterialsList();
            updatePropertiesPanel();
            updateStatusBar();
            saveProject();
            
            showToast(`${deletedCount} pe√ßa(s) exclu√≠da(s)`, 'success');
        }

        // Fun√ß√µes de snap
        function findNearestSnapPoint(x, y, threshold = 20) {
            let nearestPoint = null;
            let minDistance = threshold;
            
            appState.pieces.forEach(piece => {
                const pieceData = pieceCatalog.find(p => p.id === piece.type);
                if (!pieceData?.snapPoints) return;
                
                pieceData.snapPoints.forEach(snapPoint => {
                    const worldX = piece.x + snapPoint.x;
                    const worldY = piece.y + snapPoint.y;
                    const distance = Math.hypot(x - worldX, y - worldY);
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestPoint = { x: worldX, y: worldY };
                    }
                });
            });
            
            return nearestPoint;
        }

        function showNearbySnapPoints(x, y, threshold = 50) {
            document.querySelectorAll('.snap-point').forEach(point => {
                const pointX = parseFloat(point.getAttribute('cx'));
                const pointY = parseFloat(point.getAttribute('cy'));
                const distance = Math.hypot(x - pointX, y - pointY);
                
                if (distance < threshold) {
                    point.classList.add('visible');
                } else {
                    point.classList.remove('visible');
                }
            });
        }

        function hideSnapPoints() {
            document.querySelectorAll('.snap-point').forEach(point => {
                point.classList.remove('visible');
            });
        }

        function toggleSnap() {
            appState.snapEnabled = !appState.snapEnabled;
            updateStatusBar();
            showToast(`Snap ${appState.snapEnabled ? 'ativado' : 'desativado'}`, 'info');
        }

        function toggleGrid() {
            appState.gridEnabled = !appState.gridEnabled;
            const canvas = document.getElementById('mainCanvas');
            
            if (appState.gridEnabled) {
                canvas.style.backgroundImage = 'radial-gradient(circle, #333 1px, transparent 1px)';
            } else {
                canvas.style.backgroundImage = 'none';
            }
            
            updateStatusBar();
            showToast(`Grid ${appState.gridEnabled ? 'ativado' : 'desativado'}`, 'info');
        }

        // Fun√ß√µes de hist√≥rico
        function addToHistory(description) {
            // Remover hist√≥rico futuro se estivermos no meio
            if (appState.historyIndex < appState.history.length - 1) {
                appState.history = appState.history.slice(0, appState.historyIndex + 1);
            }
            
            // Adicionar nova a√ß√£o
            appState.history.push({
                description: description,
                state: JSON.parse(JSON.stringify(appState.pieces)),
                timestamp: new Date().toLocaleTimeString()
            });
            
            appState.historyIndex = appState.history.length - 1;
            
            // Limitar hist√≥rico a 50 a√ß√µes
            if (appState.history.length > 50) {
                appState.history.shift();
                appState.historyIndex--;
            }
            
            updateHistoryList();
        }

        function undo() {
            if (appState.historyIndex > 0) {
                appState.historyIndex--;
                const state = appState.history[appState.historyIndex];
                appState.pieces = JSON.parse(JSON.stringify(state.state));
                clearSelection();
                renderCanvas();
                updateMaterialsList();
                updatePropertiesPanel();
                updateStatusBar();
                updateHistoryList();
                showToast('Desfazer', 'info');
            }
        }

        function redo() {
            if (appState.historyIndex < appState.history.length - 1) {
                appState.historyIndex++;
                const state = appState.history[appState.historyIndex];
                appState.pieces = JSON.parse(JSON.stringify(state.state));
                clearSelection();
                renderCanvas();
                updateMaterialsList();
                updatePropertiesPanel();
                updateStatusBar();
                updateHistoryList();
                showToast('Refazer', 'info');
            }
        }

        function goToHistoryState(index) {
            if (index >= 0 && index < appState.history.length) {
                appState.historyIndex = index;
                const state = appState.history[index];
                appState.pieces = JSON.parse(JSON.stringify(state.state));
                clearSelection();
                renderCanvas();
                updateMaterialsList();
                updatePropertiesPanel();
                updateStatusBar();
                updateHistoryList();
                showToast(`Voltar para: ${state.description}`, 'info');
            }
        }

        // Fun√ß√µes de alinhamento
        function alignSelectedPieces(alignment) {
            if (appState.selectedPieces.length < 2) return;
            
            const bounds = calculateBounds(appState.selectedPieces);
            
            appState.selectedPieces.forEach(piece => {
                switch (alignment) {
                    case 'left':
                        piece.x = bounds.x;
                        break;
                    case 'center':
                        piece.x = bounds.x + bounds.width / 2;
                        break;
                    case 'right':
                        piece.x = bounds.x + bounds.width;
                        break;
                    case 'top':
                        piece.y = bounds.y;
                        break;
                    case 'middle':
                        piece.y = bounds.y + bounds.height / 2;
                        break;
                    case 'bottom':
                        piece.y = bounds.y + bounds.height;
                        break;
                }
            });
            
            addToHistory(`Alinhar ${appState.selectedPieces.length} pe√ßas`);
            renderCanvas();
            updatePropertiesPanel();
            saveProject();
            showToast(`Pe√ßas alinhadas: ${alignment}`, 'success');
        }

        function distributeSelectedPieces(direction) {
            if (appState.selectedPieces.length < 3) return;
            
            const pieces = [...appState.selectedPieces];
            
            if (direction === 'horizontal') {
                pieces.sort((a, b) => a.x - b.x);
                const totalWidth = pieces[pieces.length - 1].x - pieces[0].x;
                const spacing = totalWidth / (pieces.length - 1);
                
                pieces.forEach((piece, index) => {
                    if (index > 0 && index < pieces.length - 1) {
                        piece.x = pieces[0].x + spacing * index;
                    }
                });
            } else {
                pieces.sort((a, b) => a.y - b.y);
                const totalHeight = pieces[pieces.length - 1].y - pieces[0].y;
                const spacing = totalHeight / (pieces.length - 1);
                
                pieces.forEach((piece, index) => {
                    if (index > 0 && index < pieces.length - 1) {
                        piece.y = pieces[0].y + spacing * index;
                    }
                });
            }
            
            addToHistory(`Distribuir ${pieces.length} pe√ßas`);
            renderCanvas();
            updatePropertiesPanel();
            saveProject();
            showToast(`Pe√ßas distribu√≠das: ${direction}`, 'success');
        }

        // Fun√ß√µes de agrupamento
        function groupSelectedPieces() {
            if (appState.selectedPieces.length < 2) return;
            
            const groupId = generateId();
            const group = {
                id: groupId,
                pieces: [...appState.selectedPieces.map(p => p.id)],
                name: `Grupo ${appState.groups.length + 1}`
            };
            
            appState.groups.push(group);
            
            addToHistory(`Agrupar ${appState.selectedPieces.length} pe√ßas`);
            renderCanvas();
            showToast(`Grupo criado com ${appState.selectedPieces.length} pe√ßas`, 'success');
        }

        function ungroupSelectedPieces() {
            const selectedIds = appState.selectedPieces.map(p => p.id);
            const groupsToRemove = [];
            
            appState.groups.forEach((group, index) => {
                if (group.pieces.some(pieceId => selectedIds.includes(pieceId))) {
                    groupsToRemove.push(index);
                }
            });
            
            groupsToRemove.reverse().forEach(index => {
                appState.groups.splice(index, 1);
            });
            
            if (groupsToRemove.length > 0) {
                addToHistory(`Desagrupar ${groupsToRemove.length} grupo(s)`);
                renderCanvas();
                showToast(`${groupsToRemove.length} grupo(s) desfeito(s)`, 'success');
            }
        }

        // Fun√ß√µes de medi√ß√£o
        function startMeasurement() {
            // Implementar ferramenta de medi√ß√£o
            showToast('Clique em dois pontos para medir a dist√¢ncia', 'info');
        }

        function renderMeasurement(measurement) {
            const canvasContent = document.getElementById('canvasContent');
            
            // Linha de medi√ß√£o
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.classList.add('measurement-line');
            line.setAttribute('x1', measurement.start.x);
            line.setAttribute('y1', measurement.start.y);
            line.setAttribute('x2', measurement.end.x);
            line.setAttribute('y2', measurement.end.y);
            
            canvasContent.appendChild(line);
            
            // Texto da medi√ß√£o
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.classList.add('measurement-text');
            text.setAttribute('x', (measurement.start.x + measurement.end.x) / 2);
            text.setAttribute('y', (measurement.start.y + measurement.end.y) / 2 - 5);
            text.textContent = `${measurement.distance.toFixed(2)}mm`;
            
            canvasContent.appendChild(text);
        }

        // Fun√ß√µes de projeto
        function newProject() {
            if (appState.pieces.length > 0 && !confirm('Criar novo projeto? Todas as altera√ß√µes n√£o salvas ser√£o perdidas.')) {
                return;
            }
            
            appState.pieces = [];
            appState.selectedPieces = [];
            appState.history = [];
            appState.historyIndex = -1;
            appState.groups = [];
            appState.measurements = [];
            
            clearSelection();
            renderCanvas();
            updateMaterialsList();
            updatePropertiesPanel();
            updateHistoryList();
            updateStatusBar();
            
            localStorage.removeItem('hydraulicOptimizer');
            showToast('Novo projeto criado', 'success');
        }

        function saveProject() {
            const projectData = {
                pieces: appState.pieces,
                groups: appState.groups,
                measurements: appState.measurements,
                version: '3.0',
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('hydraulicOptimizer', JSON.stringify(projectData));
        }

        function openProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const projectData = JSON.parse(e.target.result);
                        
                        appState.pieces = projectData.pieces || [];
                        appState.groups = projectData.groups || [];
                        appState.measurements = projectData.measurements || [];
                        appState.selectedPieces = [];
                        appState.history = [];
                        appState.historyIndex = -1;
                        
                        renderCanvas();
                        updateMaterialsList();
                        updatePropertiesPanel();
                        updateHistoryList();
                        updateStatusBar();
                        
                        showToast('Projeto carregado com sucesso', 'success');
                    } catch (error) {
                        showToast('Erro ao carregar projeto', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function exportProject() {
            const projectData = {
                pieces: appState.pieces,
                groups: appState.groups,
                measurements: appState.measurements,
                version: '3.0',
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `projeto-hidraulico-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            showToast('Projeto exportado', 'success');
        }

        // Fun√ß√µes de templates
        function showTemplates() {
            document.getElementById('templatesModal').classList.add('active');
        }

        function loadTemplate(templateId) {
            const template = projectTemplates[templateId];
            if (!template) return;
            
            if (appState.pieces.length > 0 && !confirm('Carregar template? Isso substituir√° o projeto atual.')) {
                return;
            }
            
            appState.pieces = template.pieces.map(piece => ({
                id: generateId(),
                type: piece.id,
                name: pieceCatalog.find(p => p.id === piece.id)?.name || piece.id,
                x: piece.x,
                y: piece.y,
                rotation: piece.rotation,
                layer: '0',
                selected: false
            }));
            
            appState.selectedPieces = [];
            addToHistory(`Carregar template: ${template.name}`);
            
            renderCanvas();
            updateMaterialsList();
            updatePropertiesPanel();
            updateStatusBar();
            saveProject();
            
            closeModal('templatesModal');
            showToast(`Template "${template.name}" carregado`, 'success');
        }

        // Fun√ß√µes de visualiza√ß√£o 3D
        function show3DViewer() {
            document.getElementById('viewer3DModal').classList.add('active');
            initialize3DViewer();
        }

        function initialize3DViewer() {
            const container = document.getElementById('viewer3D');
            container.innerHTML = '';
            
            // Configurar Three.js
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111111);
            
            const camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.offsetWidth, container.offsetHeight);
            container.appendChild(renderer.domElement);
            
            // Ilumina√ß√£o
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);
            
            // Adicionar pe√ßas 3D
            appState.pieces.forEach(piece => {
                const pieceData = pieceCatalog.find(p => p.id === piece.type);
                if (!pieceData) return;
                
                // Criar geometria b√°sica baseada no tipo de pe√ßa
                let geometry, material;
                
                if (piece.type.includes('joelho')) {
                    geometry = new THREE.TorusGeometry(5, 2, 8, 16, Math.PI / 2);
                    material = new THREE.MeshLambertMaterial({ color: 0x8b5cf6 });
                } else if (piece.type.includes('tubo')) {
                    geometry = new THREE.CylinderGeometry(2, 2, 20, 16);
                    material = new THREE.MeshLambertMaterial({ color: 0xe5e7eb });
                } else if (piece.type.includes('te')) {
                    geometry = new THREE.BoxGeometry(10, 4, 4);
                    material = new THREE.MeshLambertMaterial({ color: 0x3b82f6 });
                } else {
                    geometry = new THREE.SphereGeometry(3, 16, 16);
                    material = new THREE.MeshLambertMaterial({ color: 0x4ade80 });
                }
                
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(piece.x / 10, -piece.y / 10, 0);
                mesh.rotation.z = piece.rotation * Math.PI / 180;
                scene.add(mesh);
            });
            
            // Posicionar c√¢mera
            camera.position.set(20, 20, 20);
            camera.lookAt(0, 0, 0);
            
            // Controles de √≥rbita
            let isRotating = false;
            let mouseX = 0, mouseY = 0;
            
            renderer.domElement.addEventListener('mousedown', (e) => {
                isRotating = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            renderer.domElement.addEventListener('mousemove', (e) => {
                if (!isRotating) return;
                
                const deltaX = e.clientX - mouseX;
                const deltaY = e.clientY - mouseY;
                
                camera.position.x = camera.position.x * Math.cos(deltaX * 0.01) - camera.position.z * Math.sin(deltaX * 0.01);
                camera.position.z = camera.position.x * Math.sin(deltaX * 0.01) + camera.position.z * Math.cos(deltaX * 0.01);
                camera.position.y += deltaY * 0.1;
                
                camera.lookAt(0, 0, 0);
                
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            renderer.domElement.addEventListener('mouseup', () => {
                isRotating = false;
            });
            
            // Loop de renderiza√ß√£o
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
            
            // Salvar refer√™ncias para controles
            window.current3DScene = { scene, camera, renderer };
        }

        function rotate3D() {
            if (!window.current3DScene) return;
            
            const { camera } = window.current3DScene;
            const radius = Math.sqrt(camera.position.x ** 2 + camera.position.z ** 2);
            const angle = Math.atan2(camera.position.z, camera.position.x) + 0.1;
            
            camera.position.x = radius * Math.cos(angle);
            camera.position.z = radius * Math.sin(angle);
            camera.lookAt(0, 0, 0);
        }

        function reset3D() {
            if (!window.current3DScene) return;
            
            const { camera } = window.current3DScene;
            camera.position.set(20, 20, 20);
            camera.lookAt(0, 0, 0);
        }

        function export3D() {
            if (!window.current3DScene) return;
            
            const { renderer } = window.current3DScene;
            const canvas = renderer.domElement;
            
            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `visualizacao-3d-${new Date().toISOString().split('T')[0]}.png`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Visualiza√ß√£o 3D exportada', 'success');
            });
        }

        // Fun√ß√µes de or√ßamento
        function showBudget() {
            document.getElementById('budgetModal').classList.add('active');
            generateBudgetReport();
        }

        function generateBudgetReport() {
            const budgetContent = document.getElementById('budgetContent');
            
            if (appState.pieces.length === 0) {
                budgetContent.innerHTML = '<p style="text-align: center; color: #888; padding: 40px;">Nenhuma pe√ßa adicionada ao projeto</p>';
                return;
            }
            
            // Agrupar pe√ßas e calcular custos
            const groupedPieces = {};
            let totalCost = 0;
            let totalPieces = 0;
            
            appState.pieces.forEach(piece => {
                const pieceData = pieceCatalog.find(p => p.id === piece.type);
                if (!pieceData) return;
                
                if (!groupedPieces[piece.type]) {
                    groupedPieces[piece.type] = {
                        data: pieceData,
                        count: 0,
                        unitCost: pieceData.price,
                        totalCost: 0
                    };
                }
                
                groupedPieces[piece.type].count++;
                groupedPieces[piece.type].totalCost += pieceData.price;
                totalCost += pieceData.price;
                totalPieces++;
            });
            
            // Gerar relat√≥rio HTML
            const currentDate = new Date().toLocaleDateString('pt-BR');
            const projectName = `Projeto Hidr√°ulico - ${currentDate}`;
            
            budgetContent.innerHTML = `
                <div style="padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #444; padding-bottom: 20px;">
                        <h2 style="margin: 0; color: #3b82f6;">${projectName}</h2>
                        <p style="margin: 5px 0; color: #888;">Or√ßamento Detalhado de Materiais</p>
                        <p style="margin: 0; font-size: 12px; color: #666;">Gerado em ${new Date().toLocaleString('pt-BR')}</p>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #4ade80; margin-bottom: 15px;">üìä Resumo do Projeto</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${totalPieces}</div>
                                <div style="font-size: 12px; color: #888;">Total de Pe√ßas</div>
                            </div>
                            <div style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #4ade80;">R$ ${totalCost.toFixed(2)}</div>
                                <div style="font-size: 12px; color: #888;">Custo Total</div>
                            </div>
                            <div style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${Object.keys(groupedPieces).length}</div>
                                <div style="font-size: 12px; color: #888;">Tipos Diferentes</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #4ade80; margin-bottom: 15px;">üìã Lista Detalhada de Materiais</h3>
                        <table style="width: 100%; border-collapse: collapse; background: #333; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background: #444;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #555;">Item</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #555;">C√≥digo</th>
                                    <th style="padding: 12px; text-align: center; border-bottom: 1px solid #555;">Qtd</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 1px solid #555;">Valor Unit.</th>
                                    <th style="padding: 12px; text-align: right; border-bottom: 1px solid #555;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.values(groupedPieces).map(group => `
                                    <tr style="border-bottom: 1px solid #444;">
                                        <td style="padding: 12px;">${group.data.name}</td>
                                        <td style="padding: 12px; color: #888; font-family: monospace;">${group.data.code}</td>
                                        <td style="padding: 12px; text-align: center; font-weight: bold;">${group.count}</td>
                                        <td style="padding: 12px; text-align: right; color: #4ade80;">R$ ${group.unitCost.toFixed(2)}</td>
                                        <td style="padding: 12px; text-align: right; font-weight: bold; color: #4ade80;">R$ ${group.totalCost.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="background: #444; font-weight: bold;">
                                    <td colspan="4" style="padding: 15px; text-align: right;">TOTAL GERAL:</td>
                                    <td style="padding: 15px; text-align: right; color: #4ade80; font-size: 18px;">R$ ${totalCost.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #4ade80; margin-bottom: 15px;">‚ÑπÔ∏è Observa√ß√µes</h3>
                        <div style="background: #333; padding: 15px; border-radius: 8px; font-size: 14px; line-height: 1.6;">
                            <p style="margin: 0 0 10px 0;">‚Ä¢ Pre√ßos baseados no cat√°logo Tigre BIM atualizado</p>
                            <p style="margin: 0 0 10px 0;">‚Ä¢ Valores n√£o incluem m√£o de obra e frete</p>
                            <p style="margin: 0 0 10px 0;">‚Ä¢ Recomenda-se margem de seguran√ßa de 10% para perdas</p>
                            <p style="margin: 0;">‚Ä¢ Or√ßamento v√°lido por 30 dias</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="exportBudgetPDF()" style="background: #ef4444; border: none; color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            üìÑ Exportar PDF
                        </button>
                        <button onclick="printBudget()" style="background: #6b7280; border: none; color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            üñ®Ô∏è Imprimir
                        </button>
                    </div>
                </div>
            `;
        }

        function exportBudgetPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // T√≠tulo
            doc.setFontSize(20);
            doc.text('Or√ßamento Hidr√°ulico', 20, 30);
            
            // Data
            doc.setFontSize(12);
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 20, 45);
            
            // Lista de materiais
            let y = 65;
            doc.setFontSize(14);
            doc.text('Lista de Materiais:', 20, y);
            y += 10;
            
            const groupedPieces = {};
            let totalCost = 0;
            
            appState.pieces.forEach(piece => {
                const pieceData = pieceCatalog.find(p => p.id === piece.type);
                if (!pieceData) return;
                
                if (!groupedPieces[piece.type]) {
                    groupedPieces[piece.type] = {
                        data: pieceData,
                        count: 0,
                        totalCost: 0
                    };
                }
                
                groupedPieces[piece.type].count++;
                groupedPieces[piece.type].totalCost += pieceData.price;
                totalCost += pieceData.price;
            });
            
            doc.setFontSize(10);
            Object.values(groupedPieces).forEach(group => {
                y += 8;
                doc.text(`${group.count}x ${group.data.name} - R$ ${group.totalCost.toFixed(2)}`, 25, y);
                doc.text(`C√≥digo: ${group.data.code}`, 25, y + 4);
                y += 4;
            });
            
            // Total
            y += 15;
            doc.setFontSize(14);
            doc.text(`TOTAL: R$ ${totalCost.toFixed(2)}`, 20, y);
            
            doc.save(`orcamento-hidraulico-${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('Or√ßamento exportado em PDF', 'success');
        }

        function printBudget() {
            window.print();
        }

        // Fun√ß√µes de importa√ß√£o DWG
        function importDWG() {
            document.getElementById('dwgModal').classList.add('active');
        }

        function processDWGFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Simular processamento de arquivo DWG
            showToast('Processando arquivo DWG...', 'info');
            
            setTimeout(() => {
                const mockBlocks = [
                    { name: 'BLOCO_JOELHO_90', description: 'Joelho 90¬∞ DN100', count: 3 },
                    { name: 'BLOCO_
